{% comment %}
Navigation Controller Snippet
Provides flexible navigation rendering with multiple control mechanisms:

1. Global theme setting (settings.show_navigation)
2. Page-level override (via force_show or force_hide parameters)
3. Custom navigation section selection

Usage Examples:
<!-- Use global setting -->
{% include 'navigation_controller' %}

<!-- Force show navigation regardless of global setting -->
{% include 'navigation_controller', force_show: true %}

<!-- Force hide navigation regardless of global setting -->
{% include 'navigation_controller', force_hide: true %}

<!-- Use custom navigation section -->
{% include 'navigation_controller', nav_section: 'nav_alt' %}

<!-- Combine custom section with forced visibility -->
{% include 'navigation_controller', nav_section: 'nav_header_static', force_show: true %}

Parameters:
- force_show: (boolean) Override global setting to show navigation
- force_hide: (boolean) Override global setting to hide navigation  
- nav_section: (string) Custom navigation section name (default: 'nav_main')
{% endcomment %}

{% assign should_show_nav = false %}

{% comment %} Determine which navigation section to render {% endcomment %}
{% assign resolved_nav_section = nav_section %}
{% if resolved_nav_section == blank %}
  {% assign resolved_nav_section = settings.global_nav_section %}
{% endif %}
{% if resolved_nav_section == blank %}
  {% assign resolved_nav_section = 'nav_main' %}
{% endif %}

{% comment %} Normalize global toggle so legacy installs without data default to true {% endcomment %}
{% assign global_nav_enabled = settings.show_navigation %}
{% if global_nav_enabled == blank %}
  {% assign global_nav_enabled = true %}
{% elsif global_nav_enabled == true or global_nav_enabled == 'true' %}
  {% assign global_nav_enabled = true %}
{% elsif global_nav_enabled == false or global_nav_enabled == 'false' %}
  {% assign global_nav_enabled = false %}
{% endif %}

{% comment %} Priority 1: Check for force_hide {% endcomment %}
{% if force_hide %}
  {% assign should_show_nav = false %}
{% comment %} Priority 2: Check for force_show {% endcomment %}
{% elsif force_show %}
  {% assign should_show_nav = true %}
{% comment %} Priority 3: Use global theme setting {% endcomment %}
{% elsif global_nav_enabled %}
  {% assign should_show_nav = true %}
{% endif %}

{% comment %}
  Apply path-based suppression unless force_show is active.
  Admins can list paths (one per line) in settings.navigation_hide_paths.
  Supports wildcard entries using * to match a prefix (e.g., /offers/*).
{% endcomment %}
{% assign hide_navigation_for_path = false %}
{% if force_show != true and should_show_nav %}
  {% assign current_path = request.path | default: '/' %}
  {% assign current_path = current_path | downcase | strip %}
  {% assign current_path = current_path | replace: '//', '/' %}
  {% assign current_length = current_path | size %}
  {% if current_length == 0 %}
    {% assign current_path = '/' %}
    {% assign current_length = 1 %}
  {% endif %}
  {% if current_path != '/' %}
    {% assign current_last_index = current_length | minus: 1 %}
    {% assign current_last_char = current_path | slice: current_last_index, 1 %}
    {% if current_last_char == '/' %}
      {% assign trimmed_length = current_length | minus: 1 %}
      {% assign current_path = current_path | slice: 0, trimmed_length %}
      {% assign current_length = current_path | size %}
      {% if current_length == 0 %}
        {% assign current_path = '/' %}
        {% assign current_length = 1 %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% assign raw_hide_paths = settings.navigation_hide_paths | default: '' %}
  {% if raw_hide_paths != '' %}
    {% assign normalized_hide_paths = raw_hide_paths | replace: '\r\n', '\n' | replace: '\r', '\n' %}
    {% assign hide_path_entries = normalized_hide_paths | split: '\n' %}
    {% for raw_entry in hide_path_entries %}
      {% assign entry = raw_entry | strip %}
      {% if entry != '' %}
        {% assign entry = entry | downcase | replace: '//', '/' %}
        {% assign is_wildcard = false %}
        {% assign entry_length = entry | size %}
        {% if entry_length > 0 %}
          {% assign entry_last_index = entry_length | minus: 1 %}
          {% assign entry_last_char = entry | slice: entry_last_index, 1 %}
          {% if entry_last_char == '*' %}
            {% assign is_wildcard = true %}
            {% assign trimmed_length = entry_length | minus: 1 %}
            {% assign entry = entry | slice: 0, trimmed_length %}
          {% endif %}
        {% endif %}
        {% assign entry_length = entry | size %}
        {% if entry_length > 0 %}
          {% assign entry_first_char = entry | slice: 0, 1 %}
          {% if entry_first_char != '/' %}
            {% assign entry = '/' | append: entry %}
          {% endif %}
        {% endif %}
        {% assign entry_length = entry | size %}
        {% if entry != '/' and entry_length > 1 %}
          {% assign entry_last_index = entry_length | minus: 1 %}
          {% assign entry_last_char = entry | slice: entry_last_index, 1 %}
          {% if entry_last_char == '/' %}
            {% assign trimmed_length = entry_length | minus: 1 %}
            {% assign entry = entry | slice: 0, trimmed_length %}
            {% assign entry_length = entry | size %}
          {% endif %}
        {% endif %}

        {% if entry_length == 0 %}
          {% assign hide_navigation_for_path = true %}
        {% elsif is_wildcard %}
          {% if current_path == entry %}
            {% assign hide_navigation_for_path = true %}
          {% elsif entry_length > 0 %}
            {% assign candidate = current_path | slice: 0, entry_length %}
            {% if candidate == entry %}
              {% assign hide_navigation_for_path = true %}
            {% endif %}
          {% endif %}
        {% elsif current_path == entry %}
          {% assign hide_navigation_for_path = true %}
        {% endif %}
      {% endif %}
      {% if hide_navigation_for_path %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% if hide_navigation_for_path %}
  {% assign should_show_nav = false %}
{% endif %}

{% comment %} Render navigation if conditions are met {% endcomment %}
{% if should_show_nav %}
  {% case resolved_nav_section %}
    {% when 'nav_alt' %}
      {% section 'nav_alt' %}
    {% when 'nav_header_static' %}
      {% section 'nav_header_static' %}
    {% when 'nav_header' %}
      {% section 'nav_header' %}
    {% when 'nav_static' %}
      {% section 'nav_static' %}
    {% when 'nav_mobile_sticky_bar' %}
      {% section 'nav_mobile_sticky_bar' %}
    {% else %}
      {% section 'nav_main' %}
  {% endcase %}
{% endif %}
