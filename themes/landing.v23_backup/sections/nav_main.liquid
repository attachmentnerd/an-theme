{% assign nav_links_override = settings.nav_links_override | default: '' | strip %}
{% if nav_links_override != '' %}
  {% assign normalized_links_string = nav_links_override | replace: '\r\n', '\n' | replace: '\r', '\n' %}
  {% assign nav_links = normalized_links_string | split: '\n' %}
{% else %}
  {% assign nav_links_string = 'About=>/about|Books=>/books|Podcast=>/podcast|Speaking=>/speaking|Program=>/program/secure-parenting|Free Downloads=>/downloads' %}
  {% assign nav_links = nav_links_string | split: '|' %}
{% endif %}

{% assign cta_label = settings.nav_cta_label | default: 'Get Started' %}
{% assign cta_url = settings.nav_cta_url | default: '/program/secure-parenting' %}
{% assign secondary_label = settings.nav_secondary_label | default: 'Free Downloads' %}
{% assign secondary_url = settings.nav_secondary_url | default: '/downloads' %}
{% assign login_url = '/login' %}
{% assign profile_label = 'Login' %}
{% assign profile_event = 'nav_login' %}
{% if current_site_user %}
  {% assign login_url = '/library' %}
  {% assign profile_label = current_site_user.name | default: current_site_user.email | default: 'My Library' %}
  {% assign profile_event = 'nav_library' %}
{% endif %}
{% assign current_path = request.path | default: '/' | downcase %}

{% comment %} Global behavior and logo settings {% endcomment %}
{% assign nav_style = settings.nav_style | default: 'solid' %}
{% assign nav_is_sticky = settings.nav_is_sticky %}
{% if nav_is_sticky == blank %}{% assign nav_is_sticky = true %}{% endif %}
{% assign nav_show_login = settings.nav_show_login %}
{% if nav_show_login == blank %}{% assign nav_show_login = true %}{% endif %}
{% assign global_nav_enabled = settings.show_navigation %}
{% if global_nav_enabled == blank %}{% assign global_nav_enabled = true %}{% endif %}

{% comment %} Resolve logo URLs from settings with sensible defaults {% endcomment %}
{% assign logo_normal = settings.nav_logo_url | default: 'https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2162370086/settings_images/708217-6dc8-6e80-0466-7b518dfb74c7_6a4860b8-00bb-47fd-8078-c7f4dd4e5385.png' %}
{% assign logo_inverted = settings.nav_logo_url_inverted | default: 'https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production//sites/2148666703/images/1d1d2ffe-9376-4248-b082-df05323d5e0b.webp' %}
{% assign use_inverted = settings.nav_use_inverted_logo %}
{% if use_inverted %}
  {% assign logo_current = logo_inverted %}
{% else %}
  {% assign logo_current = logo_normal %}
{% endif %}

{% if global_nav_enabled %}
  <style>
    #an-pill-nav-{{ section.id }} {
      {% if nav_is_sticky %}position: sticky; top: 0;{% else %}position: relative;{% endif %}
      z-index: 9999;
      padding: 1.15rem 0;
      {% if nav_style == 'transparent' %}
        background: transparent;
        backdrop-filter: none;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      {% else %}
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.96) 0%, rgba(255, 255, 255, 0.85) 60%, rgba(255, 255, 255, 0.70) 100%);
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      {% endif %}
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__logo {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__logo img {
      height: 34px;
      width: auto;
      display: block;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__pill {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.75rem;
      background: #ffffff;
      border-radius: 999px;
      box-shadow: 0 12px 35px -18px rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__link {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 66px;
      padding: 0.55rem 1.05rem;
      border-radius: 999px;
      font-size: 0.95rem;
      font-weight: 500;
      color: #374151;
      text-decoration: none;
      transition: color 0.2s ease, background 0.2s ease;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__link:hover,
    #an-pill-nav-{{ section.id }} .an-pill-nav__link:focus {
      color: #5e3bff;
      background: rgba(94, 59, 255, 0.08);
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__link--active {
      color: #5e3bff;
      font-weight: 600;
      background: rgba(94, 59, 255, 0.12);
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__actions {
      display: inline-flex;
      align-items: center;
      gap: 0.85rem;
      margin-left: auto;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__avatar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid rgba(94, 59, 255, 0.2);
      background: #ffffff;
      overflow: hidden;
      text-decoration: none;
      color: #1f2937;
      font-weight: 600;
      font-size: 0.85rem;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__cta {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.7rem 1.45rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #5e3bff 0%, #7b66ff 100%);
      color: #ffffff;
      font-weight: 600;
      font-size: 0.95rem;
      text-decoration: none;
      box-shadow: 0 16px 35px -18px rgba(94, 59, 255, 0.7);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__cta:hover,
    #an-pill-nav-{{ section.id }} .an-pill-nav__cta:focus {
      transform: translateY(-2px);
      box-shadow: 0 18px 38px -16px rgba(94, 59, 255, 0.75);
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__toggle {
      display: none;
      flex-direction: column;
      justify-content: center;
      gap: 0.3rem;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      margin-left: 0.5rem;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__toggle span {
      display: block;
      width: 20px;
      height: 2px;
      background: #1f2937;
      border-radius: 999px;
      transition: transform 0.2s ease, opacity 0.2s ease;
      margin: 0 auto;
    }

    #an-pill-nav-{{ section.id }}.is-open .an-pill-nav__toggle span:nth-child(1) {
      transform: translateY(6px) rotate(45deg);
    }

    #an-pill-nav-{{ section.id }}.is-open .an-pill-nav__toggle span:nth-child(2) {
      opacity: 0;
    }

    #an-pill-nav-{{ section.id }}.is-open .an-pill-nav__toggle span:nth-child(3) {
      transform: translateY(-6px) rotate(-45deg);
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__drawer,
    #an-pill-nav-{{ section.id }} .an-pill-nav__backdrop {
      display: none;
    }

    #an-pill-nav-{{ section.id }}.is-open .an-pill-nav__backdrop {
      display: block;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.2);
      backdrop-filter: blur(2px);
      z-index: 290;
    }

    #an-pill-nav-{{ section.id }}.is-open .an-pill-nav__drawer {
      display: flex;
      position: fixed;
      inset: 0;
      z-index: 295;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      padding: 2.5rem;
      background: #ffffff;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__drawer a {
      color: #1f2937;
      text-decoration: none;
      font-size: 1.35rem;
      font-weight: 500;
    }

    #an-pill-nav-{{ section.id }} .an-pill-nav__drawer a.an-pill-nav__cta {
      font-size: 1.1rem;
    }

    @media (max-width: 1024px) {
      #an-pill-nav-{{ section.id }} {
        padding: 0.85rem 0;
      }

      #an-pill-nav-{{ section.id }} .an-pill-nav__pill {
        display: none;
      }

      #an-pill-nav-{{ section.id }} .an-pill-nav__toggle {
        display: flex;
      }

      #an-pill-nav-{{ section.id }} .an-pill-nav__actions {
        display: none;
      }
    }
  </style>

  <nav id="an-pill-nav-{{ section.id }}" class="an-pill-nav">
    <div class="container an-pill-nav__container">
      <a class="an-pill-nav__logo" href="{{ current_site.root_url | default: '/' }}">
        <img src="{{ logo_current }}" alt="Attachment Nerd logo">
      </a>

      <div class="an-pill-nav__pill" aria-label="Primary navigation">
        {% for raw_item in nav_links %}
          {% assign parts = raw_item | split: '=>' %}
          {% assign label = parts[0] | default: '' | strip %}
          {% assign url = '/' %}
          {% if parts.size > 1 %}
            {% assign url = parts[1] | strip | default: '/' %}
          {% endif %}
          {% if label != '' %}
            {% assign normalized_url = url | downcase %}
            {% assign is_active = false %}
            {% if current_path == normalized_url or current_path == normalized_url | append: '/' %}
              {% assign is_active = true %}
            {% endif %}
            <a href="{{ url }}"
               class="an-pill-nav__link{% if is_active %} an-pill-nav__link--active{% endif %}"
               data-evt="nav_link_{{ label | handle }}">
              {{ label }}
            </a>
          {% endif %}
        {% endfor %}
      </div>

      <div class="an-pill-nav__actions">
        {% if nav_show_login %}
          {% if current_site_user %}
            <a class="an-pill-nav__avatar" href="/library" data-evt="{{ profile_event }}">
              {% assign avatar_url = current_site_user | avatar_url %}
              {% if avatar_url %}
                <img src="{{ avatar_url }}" alt="{{ current_site_user.name | default: 'Account' }}">
              {% else %}
                {{ profile_label | slice: 0, 1 | upcase }}
              {% endif %}
            </a>
          {% else %}
            <a class="an-pill-nav__avatar" href="{{ login_url }}" data-evt="{{ profile_event }}" aria-label="Login">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
              </svg>
            </a>
          {% endif %}
        {% endif %}
        <a class="an-pill-nav__cta" href="{{ cta_url }}" data-evt="nav_cta">
          {{ cta_label }}
        </a>
        <a class="an-pill-nav__cta" href="{{ secondary_url }}" data-evt="nav_cta_secondary" style="background:#ffffff;color:#5e3bff;border:1px solid rgba(94, 59, 255, 0.35);box-shadow:none;">
          {{ secondary_label }}
        </a>
      </div>

      <button class="an-pill-nav__toggle" type="button" aria-label="Toggle navigation" aria-expanded="false" data-pill-nav-toggle>
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div class="an-pill-nav__backdrop" data-pill-nav-backdrop></div>

    <div class="an-pill-nav__drawer" role="dialog" aria-modal="true" aria-label="Mobile navigation" data-pill-nav-drawer>
      <a class="an-pill-nav__logo" href="{{ current_site.root_url | default: '/' }}" style="margin-bottom: 1rem;">
        <img src="{{ logo_current }}" alt="Attachment Nerd logo" style="height: 34px; width: auto;">
      </a>
      {% for raw_item in nav_links %}
        {% assign parts = raw_item | split: '=>' %}
        {% assign label = parts[0] | default: '' | strip %}
        {% assign url = '/' %}
        {% if parts.size > 1 %}
          {% assign url = parts[1] | strip | default: '/' %}
        {% endif %}
        {% if label != '' %}
          <a href="{{ url }}" data-evt="nav_link_mobile_{{ label | handle }}">{{ label }}</a>
        {% endif %}
      {% endfor %}
      <a class="an-pill-nav__cta" href="{{ cta_url }}" data-evt="nav_cta_mobile">{{ cta_label }}</a>
      <a class="an-pill-nav__cta" href="{{ secondary_url }}" data-evt="nav_cta_secondary_mobile" style="background:#ffffff;color:#5e3bff;border:1px solid rgba(94, 59, 255, 0.35);box-shadow:none;">{{ secondary_label }}</a>
      {% if nav_show_login %}
        {% unless current_site_user %}
          <a href="{{ login_url }}" data-evt="nav_login_mobile">{{ profile_label }}</a>
        {% endunless %}
      {% endif %}
    </div>
  </nav>

  <script>
    (function () {
      var nav = document.getElementById('an-pill-nav-{{ section.id }}');
      if (!nav) { return; }
      var toggle = nav.querySelector('[data-pill-nav-toggle]');
      var backdrop = nav.querySelector('[data-pill-nav-backdrop]');
      var drawer = nav.querySelector('[data-pill-nav-drawer]');
      if (!toggle || !backdrop || !drawer) { return; }

      function closeNav() {
        nav.classList.remove('is-open');
        toggle.setAttribute('aria-expanded', 'false');
      }

      toggle.addEventListener('click', function () {
        var isOpen = nav.classList.toggle('is-open');
        toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });

      backdrop.addEventListener('click', closeNav);

      document.addEventListener('keyup', function (event) {
        if (event.key === 'Escape') {
          closeNav();
        }
      });

      drawer.querySelectorAll('a').forEach(function (link) {
        link.addEventListener('click', closeNav);
      });
    })();
  </script>
  {% endif %}

{% schema %}
{
  "name": "Navigation",
  "elements": []
}
{% endschema %}
