{% comment %}
  Announcement Banner Section
  - Gradient/solid background, dotted pattern option
  - Icon, headline, message, optional link CTA
  - Supports multiple announcement blocks
  - Dismiss button with per-session storage
{% endcomment %}

<section id="{{ section.settings.section_id | default: 'announcement-banner' }}-{{ section.id }}" class="announcement-banner" style="padding: {{ section.settings.padding_y }}px 0;">
  <div class="container">
    {% assign banner_announcement = nil %}
    {% if section.settings.data_source == 'announcement' %}
      {% assign ann_sorted = announcements | sort: 'updated_at' %}
      {% if ann_sorted and ann_sorted.size > 0 %}
        {% assign banner_announcement = ann_sorted | last %}
      {% endif %}
    {% endif %}

    <div class="ab-wrapper background"
      style="
        background: {% if section.settings.bg_type == 'gradient' %}linear-gradient({{ section.settings.gradient_angle }}deg, {{ section.settings.gradient_from }} 0%, {{ section.settings.gradient_to }} 100%){% else %}{{ section.settings.bg_color }}{% endif %};
        border-radius: {{ section.settings.radius }}px;
        padding: {{ section.settings.card_padding }}px;
        {% if section.settings.shadow %}box-shadow: 0 10px 30px rgba(0,0,0,.12);{% endif %}
      "
      data-storage-key="ab-dismiss-{{ section.id }}">
      {% if section.settings.show_pattern %}
        <div class="ab-pattern"></div>
      {% endif %}
      <div class="ab-grid">
        {% if section.settings.data_source != 'announcement' %}
          <div class="ab-icon" aria-hidden="true" style="color: {{ section.settings.icon_bg }}; background: rgba(255,255,255,.16);">
            {% if section.settings.icon_choice == 'bell' %}üîî{% elsif section.settings.icon_choice == 'star' %}‚≠ê{% else %}‚ÑπÔ∏è{% endif %}
          </div>
        {% endif %}
        <div class="ab-content" style="color: {{ section.settings.text_color }};">
          {% if section.settings.data_source != 'announcement' and section.settings.headline != blank %}
            <div class="ab-headline" style="color: {{ section.settings.headline_color }};">{{ section.settings.headline }}</div>
          {% endif %}

          {% if section.settings.data_source == 'announcement' and banner_announcement %}
            {% assign announcement = banner_announcement %}
            {% include "announcement" %}
          {% elsif section.blocks.size > 0 %}
            {% for block in section.blocks %}
              {% if block.type == 'announcement' %}
                <div id="block-{{ block.id }}" class="ab-item">
                  {% if block.settings.title != blank %}
                    <div class="ab-title">{{ block.settings.title }}</div>
                  {% endif %}
                  {% if block.settings.message != blank %}
                    <div class="ab-message">{{ block.settings.message }}</div>
                  {% endif %}
                  {% if block.settings.link_text != blank and block.settings.link_url != blank %}
                    <a href="{{ block.settings.link_url }}" class="ab-link" {% if block.settings.new_tab %}target="_blank" rel="noopener"{% endif %}>{{ block.settings.link_text }}</a>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {% if section.settings.message != blank %}
              <div class="ab-item">
                {% if section.settings.title != blank %}<div class="ab-title">{{ section.settings.title }}</div>{% endif %}
                <div class="ab-message">{{ section.settings.message }}</div>
              </div>
            {% endif %}
          {% endif %}
        </div>
        <button class="ab-dismiss" type="button" aria-label="Dismiss" title="Dismiss" style="color: {{ section.settings.dismiss_color }}; background: rgba(255,255,255,.16);">√ó</button>
      </div>
    </div>
  </div>
</section>

<style>
  .announcement-banner .ab-wrapper { position: relative; overflow: hidden; }
  .announcement-banner .ab-pattern { position: absolute; inset: 0; background-image: radial-gradient(currentColor 1px, transparent 1px); background-size: 20px 20px; opacity: .25; color: rgba(255,255,255,.9); pointer-events: none; }
  .announcement-banner .ab-grid { display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: center; }
  .announcement-banner .ab-icon { width: 44px; height: 44px; display: grid; place-items: center; border-radius: 999px; font-size: 22px; }
  .announcement-banner .ab-headline { font-weight: 700; margin-bottom: 2px; }
  .announcement-banner .ab-title { font-weight: 600; margin-bottom: 2px; }
  .announcement-banner .ab-message { opacity: .95; }
  .announcement-banner .ab-link { color: {{ section.settings.link_color }}; text-decoration: underline; font-weight: 600; margin-left: 8px; }
  .announcement-banner .ab-dismiss { width: 36px; height: 36px; border: none; border-radius: 999px; display: grid; place-items: center; font-size: 18px; cursor: pointer; }
  @media (max-width: 768px) { .announcement-banner .ab-grid { grid-template-columns: auto 1fr auto; gap: 12px; } }
</style>

<script>
  (function(){
    var root = document.getElementById('{{ section.settings.section_id | default: 'announcement-banner' }}-{{ section.id }}');
    if(!root) return;
    var wrapper = root.querySelector('.ab-wrapper');
    var key = wrapper && wrapper.getAttribute('data-storage-key');
    try { if(key && sessionStorage.getItem(key) === '1') { root.style.display = 'none'; } } catch(e){}
    var btn = root.querySelector('.ab-dismiss');
    if(btn){ btn.addEventListener('click', function(){ root.style.display='none'; try{ if(key) sessionStorage.setItem(key,'1'); }catch(e){} }); }
  })();
  </script>

{% schema %}
{
  "name": "Announcement - Banner",
  "elements": [
    { "type": "text", "id": "section_id", "label": "Section ID", "default": "announcement-banner" },
    { "type": "range", "id": "padding_y", "label": "Section Padding Y", "min": 8, "max": 64, "step": 4, "unit": "px", "default": 16 },

    { "type": "header", "content": "Source" },
    { "type": "select", "id": "data_source", "label": "Data Source", "default": "announcement", "options": [ {"label":"Manual","value":"manual"}, {"label":"Latest Announcement","value":"announcement"} ] },
    { "type": "checkbox", "id": "use_body", "label": "Use announcement body (else title)", "default": false },
    { "type": "range", "id": "truncate_length", "label": "Body truncate length", "min": 40, "max": 320, "step": 10, "default": 160 },
    { "type": "checkbox", "id": "show_product_name", "label": "Show product name (if any)", "default": true },
    { "type": "checkbox", "id": "show_link", "label": "Show link to announcement", "default": true },
    { "type": "text", "id": "link_text", "label": "Link text", "default": "Read more ‚Üí" },
    { "type": "checkbox", "id": "link_new_tab", "label": "Open link in new tab", "default": false },

    { "type": "header", "content": "Background" },
    { "type": "select", "id": "bg_type", "label": "Background Type", "default": "gradient", "options": [ {"label": "Gradient", "value": "gradient"}, {"label": "Solid", "value": "solid"} ] },
    { "type": "color", "id": "bg_color", "label": "Solid Color", "default": "#0CCAD4" },
    { "type": "color", "id": "gradient_from", "label": "Gradient From", "default": "#6C4CF7" },
    { "type": "color", "id": "gradient_to", "label": "Gradient To", "default": "#19D6D0" },
    { "type": "range", "id": "gradient_angle", "label": "Gradient Angle", "min": 0, "max": 360, "step": 5, "unit": "deg", "default": 135 },
    { "type": "checkbox", "id": "show_pattern", "label": "Show dotted pattern", "default": true },
    { "type": "range", "id": "radius", "label": "Card Radius", "min": 0, "max": 32, "step": 2, "unit": "px", "default": 12 },
    { "type": "range", "id": "card_padding", "label": "Card Padding", "min": 8, "max": 48, "step": 4, "unit": "px", "default": 16 },
    { "type": "checkbox", "id": "shadow", "label": "Shadow", "default": true },

    { "type": "header", "content": "Content" },
    { "type": "select", "id": "icon_choice", "label": "Icon", "default": "bell", "options": [ {"label":"Bell","value":"bell"}, {"label":"Star","value":"star"}, {"label":"Info","value":"info"} ] },
    { "type": "color", "id": "icon_bg", "label": "Icon Accent", "default": "#FFFFFF" },
    { "type": "text", "id": "headline", "label": "Headline", "default": "New Module Available" },
    { "type": "color", "id": "headline_color", "label": "Headline Color", "default": "#FFFFFF" },
    { "type": "color", "id": "text_color", "label": "Text Color", "default": "#FFFFFF" },
    { "type": "color", "id": "link_color", "label": "Link Color", "default": "#FFFFFF" },
    { "type": "text", "id": "title", "label": "Fallback Title", "default": "Sleep & Bedtime Without Battles" },
    { "type": "textarea", "id": "message", "label": "Fallback Message", "default": "is now live in your library" },
    { "type": "color", "id": "dismiss_color", "label": "Dismiss Icon Color", "default": "#FFFFFF" }
  ],
  "blocks": [
    {
      "type": "announcement",
      "name": "Announcement",
      "elements": [
        { "type": "text", "id": "title", "label": "Title", "default": "New Module Available" },
        { "type": "textarea", "id": "message", "label": "Message", "default": "Sleep & Bedtime Without Battles is now live in your library" },
        { "type": "text", "id": "link_text", "label": "Link Text", "default": "View" },
        { "type": "action", "id": "link_url", "label": "Link URL", "anchor": true },
        { "type": "checkbox", "id": "new_tab", "label": "Open in new tab", "default": false }
      ]
    }
  ],
  "presets": [
    {
      "name": "Announcement - Banner",
      "category": "Messaging",
      "blocks": [ { "type": "announcement" } ]
    }
  ]
}
{% endschema %}


