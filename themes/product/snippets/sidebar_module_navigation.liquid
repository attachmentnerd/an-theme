{% comment %}
  Sidebar Module Navigation Block
  Links to other modules with intelligent current module detection
  Auto-hides current module from navigation
{% endcomment %}

{% assign current_url = request.path %}
{% assign hide_current = block.settings.hide_current | default: true %}
{% assign bg_color = block.settings.background_color | default: '#f8f9fa' %}
{% assign accent_color = block.settings.accent_color | default: settings.color_button | default: '#5E3BFF' %}
{% assign btn_style = block.settings.btn_style | default: 'solid' %}
{% assign btn_size = block.settings.btn_size | default: 'small' %}
{% assign enable_expand = block.settings.enable_expand | default: true %}
{% assign initial_items = block.settings.initial_items | default: 3 | plus: 0 %}
{% assign module_count = 0 %}
{% assign open_new_window = block.settings.open_new_window | default: false %}

<div class="sidebar-block module-navigation-block" style="background-color: {{ bg_color }};">
  {% if block.settings.heading %}
    <h3 class="sidebar-block__title">{{ block.settings.heading }}</h3>
  {% endif %}

  <div class="module-nav-content">
    <ul class="module-nav-list" id="module-nav-list-{{ block.id }}">
      {% comment %} Module 1 {% endcomment %}
      {% if block.settings.module1_title %}
        {% assign is_current = false %}
        {% assign module_url = block.settings.module1_url | default: '#' | strip %}

        {% if module_url != '#' and module_url != '' %}
          {% if module_url == current_url %}
            {% assign is_current = true %}
          {% elsif module_url != '/' %}
            {% if current_url contains module_url %}
              {% assign is_current = true %}
            {% elsif module_url contains current_url and current_url != '/' %}
              {% assign is_current = true %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% unless is_current and hide_current %}
          {% assign module_count = module_count | plus: 1 %}
          <li class="module-nav-item{% if is_current %} is-current{% endif %}{% if enable_expand and module_count > initial_items %} module-nav-hidden{% endif %}" data-module-index="{{ module_count }}">
            <a href="{{ module_url | default: '#' }}" class="module-nav-link{% if is_current %} is-active{% endif %}{% if block.settings.module1_status == 'locked' %} is-locked{% endif %}"{% if open_new_window %} target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="module-number">1</span>
              <span class="module-text">
                {% if block.settings.module1_label %}
                  <span class="module-label">{{ block.settings.module1_label }}</span>
                {% endif %}
                <span class="module-title">{{ block.settings.module1_title }}</span>
              </span>
              {% if block.settings.module1_status == 'complete' %}
                <span class="module-status complete">âœ“</span>
              {% elsif block.settings.module1_status == 'locked' %}
                <span class="module-status locked">ðŸ”’</span>
              {% endif %}
            </a>
          </li>
        {% endunless %}
      {% endif %}

      {% comment %} Module 2 {% endcomment %}
      {% if block.settings.module2_title %}
        {% assign is_current = false %}
        {% assign module_url = block.settings.module2_url | default: '#' | strip %}

        {% if module_url != '#' and module_url != '' %}
          {% if module_url == current_url %}
            {% assign is_current = true %}
          {% elsif module_url != '/' %}
            {% if current_url contains module_url %}
              {% assign is_current = true %}
            {% elsif module_url contains current_url and current_url != '/' %}
              {% assign is_current = true %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% unless is_current and hide_current %}
          {% assign module_count = module_count | plus: 1 %}
          <li class="module-nav-item{% if is_current %} is-current{% endif %}{% if enable_expand and module_count > initial_items %} module-nav-hidden{% endif %}" data-module-index="{{ module_count }}">
            <a href="{{ module_url | default: '#' }}" class="module-nav-link{% if is_current %} is-active{% endif %}{% if block.settings.module2_status == 'locked' %} is-locked{% endif %}"{% if open_new_window %} target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="module-number">2</span>
              <span class="module-text">
                {% if block.settings.module2_label %}
                  <span class="module-label">{{ block.settings.module2_label }}</span>
                {% endif %}
                <span class="module-title">{{ block.settings.module2_title }}</span>
              </span>
              {% if block.settings.module2_status == 'complete' %}
                <span class="module-status complete">âœ“</span>
              {% elsif block.settings.module2_status == 'locked' %}
                <span class="module-status locked">ðŸ”’</span>
              {% endif %}
            </a>
          </li>
        {% endunless %}
      {% endif %}

      {% comment %} Module 3 {% endcomment %}
      {% if block.settings.module3_title %}
        {% assign is_current = false %}
        {% assign module_url = block.settings.module3_url | default: '#' | strip %}

        {% if module_url != '#' and module_url != '' %}
          {% if module_url == current_url %}
            {% assign is_current = true %}
          {% elsif module_url != '/' %}
            {% if current_url contains module_url %}
              {% assign is_current = true %}
            {% elsif module_url contains current_url and current_url != '/' %}
              {% assign is_current = true %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% unless is_current and hide_current %}
          {% assign module_count = module_count | plus: 1 %}
          <li class="module-nav-item{% if is_current %} is-current{% endif %}{% if enable_expand and module_count > initial_items %} module-nav-hidden{% endif %}" data-module-index="{{ module_count }}">
            <a href="{{ module_url | default: '#' }}" class="module-nav-link{% if is_current %} is-active{% endif %}{% if block.settings.module3_status == 'locked' %} is-locked{% endif %}"{% if open_new_window %} target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="module-number">3</span>
              <span class="module-text">
                {% if block.settings.module3_label %}
                  <span class="module-label">{{ block.settings.module3_label }}</span>
                {% endif %}
                <span class="module-title">{{ block.settings.module3_title }}</span>
              </span>
              {% if block.settings.module3_status == 'complete' %}
                <span class="module-status complete">âœ“</span>
              {% elsif block.settings.module3_status == 'locked' %}
                <span class="module-status locked">ðŸ”’</span>
              {% endif %}
            </a>
          </li>
        {% endunless %}
      {% endif %}

      {% comment %} Module 4 {% endcomment %}
      {% if block.settings.module4_title %}
        {% assign is_current = false %}
        {% assign module_url = block.settings.module4_url | default: '#' | strip %}

        {% if module_url != '#' and module_url != '' %}
          {% if module_url == current_url %}
            {% assign is_current = true %}
          {% elsif module_url != '/' %}
            {% if current_url contains module_url %}
              {% assign is_current = true %}
            {% elsif module_url contains current_url and current_url != '/' %}
              {% assign is_current = true %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% unless is_current and hide_current %}
          {% assign module_count = module_count | plus: 1 %}
          <li class="module-nav-item{% if is_current %} is-current{% endif %}{% if enable_expand and module_count > initial_items %} module-nav-hidden{% endif %}" data-module-index="{{ module_count }}">
            <a href="{{ module_url | default: '#' }}" class="module-nav-link{% if is_current %} is-active{% endif %}{% if block.settings.module4_status == 'locked' %} is-locked{% endif %}"{% if open_new_window %} target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="module-number">4</span>
              <span class="module-text">
                {% if block.settings.module4_label %}
                  <span class="module-label">{{ block.settings.module4_label }}</span>
                {% endif %}
                <span class="module-title">{{ block.settings.module4_title }}</span>
              </span>
              {% if block.settings.module4_status == 'complete' %}
                <span class="module-status complete">âœ“</span>
              {% elsif block.settings.module4_status == 'locked' %}
                <span class="module-status locked">ðŸ”’</span>
              {% endif %}
            </a>
          </li>
        {% endunless %}
      {% endif %}

      {% comment %} Module 5 {% endcomment %}
      {% if block.settings.module5_title %}
        {% assign is_current = false %}
        {% assign module_url = block.settings.module5_url | default: '#' | strip %}

        {% if module_url != '#' and module_url != '' %}
          {% if module_url == current_url %}
            {% assign is_current = true %}
          {% elsif module_url != '/' %}
            {% if current_url contains module_url %}
              {% assign is_current = true %}
            {% elsif module_url contains current_url and current_url != '/' %}
              {% assign is_current = true %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% unless is_current and hide_current %}
          {% assign module_count = module_count | plus: 1 %}
          <li class="module-nav-item{% if is_current %} is-current{% endif %}{% if enable_expand and module_count > initial_items %} module-nav-hidden{% endif %}" data-module-index="{{ module_count }}">
            <a href="{{ module_url | default: '#' }}" class="module-nav-link{% if is_current %} is-active{% endif %}{% if block.settings.module5_status == 'locked' %} is-locked{% endif %}"{% if open_new_window %} target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="module-number">5</span>
              <span class="module-text">
                {% if block.settings.module5_label %}
                  <span class="module-label">{{ block.settings.module5_label }}</span>
                {% endif %}
                <span class="module-title">{{ block.settings.module5_title }}</span>
              </span>
              {% if block.settings.module5_status == 'complete' %}
                <span class="module-status complete">âœ“</span>
              {% elsif block.settings.module5_status == 'locked' %}
                <span class="module-status locked">ðŸ”’</span>
              {% endif %}
            </a>
          </li>
        {% endunless %}
      {% endif %}

      {% comment %} Module 6 {% endcomment %}
      {% if block.settings.module6_title %}
        {% assign is_current = false %}
        {% assign module_url = block.settings.module6_url | default: '#' | strip %}

        {% if module_url != '#' and module_url != '' %}
          {% if module_url == current_url %}
            {% assign is_current = true %}
          {% elsif module_url != '/' %}
            {% if current_url contains module_url %}
              {% assign is_current = true %}
            {% elsif module_url contains current_url and current_url != '/' %}
              {% assign is_current = true %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% unless is_current and hide_current %}
          {% assign module_count = module_count | plus: 1 %}
          <li class="module-nav-item{% if is_current %} is-current{% endif %}{% if enable_expand and module_count > initial_items %} module-nav-hidden{% endif %}" data-module-index="{{ module_count }}">
            <a href="{{ module_url | default: '#' }}" class="module-nav-link{% if is_current %} is-active{% endif %}{% if block.settings.module6_status == 'locked' %} is-locked{% endif %}"{% if open_new_window %} target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="module-number">6</span>
              <span class="module-text">
                {% if block.settings.module6_label %}
                  <span class="module-label">{{ block.settings.module6_label }}</span>
                {% endif %}
                <span class="module-title">{{ block.settings.module6_title }}</span>
              </span>
              {% if block.settings.module6_status == 'complete' %}
                <span class="module-status complete">âœ“</span>
              {% elsif block.settings.module6_status == 'locked' %}
                <span class="module-status locked">ðŸ”’</span>
              {% endif %}
            </a>
          </li>
        {% endunless %}
      {% endif %}
    </ul>

    {% comment %} Show More/Less Button {% endcomment %}
    {% if enable_expand and module_count > initial_items %}
      <button type="button" class="module-nav-expand-btn" id="module-nav-expand-{{ block.id }}" aria-expanded="false">
        <span class="expand-text">{{ block.settings.expand_text | default: 'Show all modules' }}</span>
        <span class="collapse-text" style="display: none;">{{ block.settings.collapse_text | default: 'Show less' }}</span>
        <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    {% endif %}

    {% if block.settings.show_cta and block.settings.cta_text %}
      <div class="module-nav-cta">
        <a href="{{ block.settings.cta_url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }} btn-block"{% if open_new_window %} target="_blank" rel="noopener noreferrer"{% endif %}>
          {{ block.settings.cta_text }}
        </a>
      </div>
    {% endif %}
  </div>
</div>

<style>
  .module-navigation-block {
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
  }

  .module-navigation-block .sidebar-block__title {
    margin: 0 0 15px 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .module-nav-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .module-nav-item {
    margin-bottom: 8px;
  }

  .module-nav-item:last-child {
    margin-bottom: 0;
  }

  .module-nav-link {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    transition: all 0.2s ease;
    position: relative;
  }

  .module-nav-link:hover:not(.is-locked) {
    background: #f9fafb;
    border-color: {{ accent_color }}40;
    transform: translateX(2px);
  }

  .module-nav-link.is-active {
    background: {{ accent_color }};
    color: white;
    border-color: {{ accent_color }};
    font-weight: 600;
  }

  .module-nav-link.is-active:hover {
    background: {{ accent_color | color_darken: 10 }};
    transform: none;
  }

  .module-nav-link.is-locked {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .module-nav-link.is-locked:hover {
    transform: none;
    background: #fff;
    border-color: #e5e7eb;
  }

  .module-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: #f3f4f6;
    border-radius: 6px;
    font-weight: 700;
    font-size: 14px;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .module-nav-link.is-active .module-number {
    background: rgba(255,255,255,0.2);
  }

  .module-text {
    flex: 1;
    min-width: 0;
  }

  .module-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.7;
    margin-bottom: 2px;
  }

  .module-title {
    display: block;
    font-size: 14px;
    line-height: 1.3;
  }

  .module-status {
    flex-shrink: 0;
    margin-left: 8px;
    font-size: 16px;
  }

  .module-status.complete {
    color: #10b981;
  }

  .module-status.locked {
    opacity: 0.5;
  }

  .module-nav-cta {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
  }

  .module-nav-cta .btn {
    {% if accent_color %}
      {% if btn_style == 'solid' %}
        background-color: {{ accent_color }};
        border-color: {{ accent_color }};
      {% else %}
        color: {{ accent_color }};
        border-color: {{ accent_color }};
      {% endif %}
    {% endif %}
  }

  .module-nav-cta .btn:hover {
    {% if accent_color %}
      {% if btn_style == 'solid' %}
        background-color: {{ accent_color | color_darken: 10 }};
        border-color: {{ accent_color | color_darken: 10 }};
      {% else %}
        background-color: {{ accent_color }};
        border-color: {{ accent_color }};
        color: white;
      {% endif %}
    {% endif %}
  }

  /* Button size variations */
  .btn-small {
    padding: 6px 12px;
    font-size: 13px;
  }

  .btn-med {
    padding: 8px 16px;
    font-size: 14px;
  }

  .btn-large {
    padding: 10px 20px;
    font-size: 15px;
  }

  /* Button style variations */
  .btn-outline {
    background-color: transparent;
    border: 1px solid;
  }

  .btn-block {
    display: block;
    width: 100%;
  }

  /* Expand/Collapse Functionality */
  .module-nav-hidden {
    display: none;
  }

  .module-nav-hidden.is-expanded {
    display: block;
    animation: slideDown 0.3s ease-out forwards;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .module-nav-expand-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    margin-top: 12px;
    padding: 10px 16px;
    background: transparent;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    color: {{ accent_color }};
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .module-nav-expand-btn:hover {
    background: #f9fafb;
    border-color: {{ accent_color }};
  }

  .module-nav-expand-btn:focus {
    outline: 2px solid {{ accent_color }};
    outline-offset: 2px;
  }

  .module-nav-expand-btn .expand-icon {
    transition: transform 0.3s ease;
  }

  .module-nav-expand-btn[aria-expanded="true"] .expand-icon {
    transform: rotate(180deg);
  }
</style>

<script>
  (function() {
    // Prevent clicks on locked modules
    document.querySelectorAll('.module-nav-link.is-locked').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
      });
    });

    // Expand/Collapse functionality
    const expandBtn = document.getElementById('module-nav-expand-{{ block.id }}');
    const list = document.getElementById('module-nav-list-{{ block.id }}');

    if (expandBtn && list) {
      const hiddenItems = list.querySelectorAll('.module-nav-hidden');
      const expandText = expandBtn.querySelector('.expand-text');
      const collapseText = expandBtn.querySelector('.collapse-text');

      expandBtn.addEventListener('click', function() {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';

        if (!isExpanded) {
          // Expand
          hiddenItems.forEach(function(item) {
            item.classList.add('is-expanded');
          });
          this.setAttribute('aria-expanded', 'true');
          if (expandText) expandText.style.display = 'none';
          if (collapseText) collapseText.style.display = 'inline';
        } else {
          // Collapse
          hiddenItems.forEach(function(item) {
            item.classList.remove('is-expanded');
          });
          this.setAttribute('aria-expanded', 'false');
          if (expandText) expandText.style.display = 'inline';
          if (collapseText) collapseText.style.display = 'none';
        }
      });

      // Auto-expand if current module is hidden
      const currentItem = list.querySelector('.module-nav-item.is-current');
      if (currentItem && currentItem.classList.contains('module-nav-hidden')) {
        expandBtn.click();
      }
    }
  })();
</script>