{% comment %}
  Sidebar Continue Learning Block
  Shows continue/start buttons for current or all enrolled products
{% endcomment %}

{% assign show_all = block.settings.show_all_products %}
{% assign max_products = block.settings.max_products | default: 3 %}
{% assign bg_color = block.settings.background_color | default: '#f8f9fa' %}
{% assign btn_color = block.settings.btn_color | default: settings.color_button %}
{% assign btn_style = block.settings.btn_style | default: 'solid' %}
{% assign btn_size = block.settings.btn_size | default: 'small' %}

<div class="sidebar-block continue-learning-block" style="background-color: {{ bg_color }};">
  {% if block.settings.heading %}
    <h3 class="sidebar-block__title">{{ block.settings.heading }}</h3>
  {% endif %}

  <div class="continue-learning-content">
    {% if show_all and member.products.size > 0 %}
      <!-- Show all enrolled products -->
      {% assign product_count = 0 %}
      {% for product in member.products %}
        {% if product_count < max_products %}
          {% assign completion = product.completion %}

          <div class="product-continue-item">
            {% if product.thumbnail_url %}
              <img src="{{ product.thumbnail_url | image_url: '80x' }}" alt="{{ product.title }}" class="product-thumb">
            {% endif %}

            <div class="product-info">
              <h4 class="product-title">{{ product.title }}</h4>
              <span class="product-progress">{{ completion.percent }}% complete</span>
            </div>

            <div class="product-action">
              {% if completion.percent == 100 %}
                <a href="{{ product.url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }}">
                  {{ block.settings.review_text | default: 'Review' }}
                </a>
              {% elsif completion.percent > 0 %}
                {% comment %} Find next uncompleted lesson {% endcomment %}
                {% assign next_lesson_url = nil %}
                {% for post in product.posts %}
                  {% unless post.is_completed %}
                    {% assign next_lesson_url = post.url %}
                    {% break %}
                  {% endunless %}
                {% endfor %}

                {% if next_lesson_url %}
                  <a href="{{ next_lesson_url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }}">
                    {{ block.settings.continue_text | default: 'Continue' }}
                  </a>
                {% else %}
                  <a href="{{ product.url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }}">
                    {{ block.settings.continue_text | default: 'Continue' }}
                  </a>
                {% endif %}
              {% else %}
                <a href="{{ product.url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }}">
                  {{ block.settings.start_text | default: 'Start' }}
                </a>
              {% endif %}
            </div>
          </div>

          {% assign product_count = product_count | plus: 1 %}
        {% endif %}
      {% endfor %}

    {% elsif current_product %}
      <!-- Show only current product -->
      {% assign completion = current_product.completion %}

      <div class="product-continue-item single">
        <div class="product-info">
          <span class="product-progress">{{ completion.percent }}% complete</span>
        </div>

        <div class="product-action">
          {% if completion.percent == 100 %}
            <a href="{{ current_product.url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }} btn-block">
              {{ block.settings.review_text | default: 'Review Course' }}
            </a>
          {% elsif completion.percent > 0 %}
            {% comment %} Find next uncompleted lesson in current product {% endcomment %}
            {% assign next_lesson_url = nil %}
            {% assign next_lesson_title = nil %}
            {% for post in current_product.posts %}
              {% unless post.is_completed %}
                {% assign next_lesson_url = post.url %}
                {% assign next_lesson_title = post.title %}
                {% break %}
              {% endunless %}
            {% endfor %}

            {% if next_lesson_url %}
              <a href="{{ next_lesson_url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }} btn-block">
                {{ block.settings.continue_text | default: 'Continue Learning' }}
              </a>
            {% else %}
              <a href="{{ current_product.url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }} btn-block">
                {{ block.settings.continue_text | default: 'Continue Learning' }}
              </a>
            {% endif %}
          {% else %}
            {% if current_product.posts.size > 0 %}
              <a href="{{ current_product.posts.first.url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }} btn-block">
                {{ block.settings.start_text | default: 'Start Course' }}
              </a>
            {% else %}
              <a href="{{ current_product.url }}" class="btn btn-{{ btn_size }} btn-{{ btn_style }} btn-block">
                {{ block.settings.start_text | default: 'Start Course' }}
              </a>
            {% endif %}
          {% endif %}

          {% if next_lesson_title %}
            <div class="next-lesson-info">
              <small>Next: {{ next_lesson_title | truncate: 30 }}</small>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>

<style>
  .continue-learning-block {
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
  }

  .continue-learning-block .sidebar-block__title {
    margin: 0 0 15px 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .product-continue-item {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }

  .product-continue-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .product-continue-item.single {
    border-bottom: none;
    margin-bottom: 0;
  }

  .product-thumb {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
  }

  .product-info {
    flex: 1;
  }

  .product-title {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 4px 0;
    line-height: 1.3;
  }

  .product-progress {
    font-size: 12px;
    color: #666;
  }

  .product-action .btn {
    width: 100%;
    {% if btn_color %}
      {% if btn_style == 'solid' %}
        background-color: {{ btn_color }};
        border-color: {{ btn_color }};
      {% else %}
        color: {{ btn_color }};
        border-color: {{ btn_color }};
      {% endif %}
    {% endif %}
  }

  .product-action .btn:hover {
    {% if btn_color %}
      {% if btn_style == 'solid' %}
        background-color: {{ btn_color | color_darken: 10 }};
        border-color: {{ btn_color | color_darken: 10 }};
      {% else %}
        background-color: {{ btn_color }};
        border-color: {{ btn_color }};
        color: white;
      {% endif %}
    {% endif %}
  }

  .next-lesson-info {
    margin-top: 8px;
    text-align: center;
  }

  .next-lesson-info small {
    color: #888;
    font-size: 11px;
  }

  /* Button size variations */
  .btn-small {
    padding: 6px 12px;
    font-size: 13px;
  }

  .btn-med {
    padding: 8px 16px;
    font-size: 14px;
  }

  .btn-large {
    padding: 10px 20px;
    font-size: 15px;
  }

  /* Button style variations */
  .btn-outline {
    background-color: transparent;
    border: 1px solid;
  }

  .btn-block {
    display: block;
    width: 100%;
  }
</style>