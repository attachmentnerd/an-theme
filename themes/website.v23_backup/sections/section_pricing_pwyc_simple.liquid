{% comment %}
  Pricing - PWYC (Simple)
  - Quick tier buttons + slider snapping to configured tiers
  - Live readout updates CTA, label, description, and URL
  - Self-contained CSS + JS, using design tokens and AN classes
{% endcomment %}

<section id="pwyc-simple-{{ section.id }}" class="an-section an-theme"
         style="background: var(--c-white,#fff); color: var(--c-ink-900,#1B1B29)"
         data-url-floor="{{ section.settings.checkout_url_floor }}"
         data-url-anchor="{{ section.settings.checkout_url_anchor }}"
         data-url-forward="{{ section.settings.checkout_url_forward }}">
  <div class="an-container">
    <h2 class="an-title-lg">{{ section.settings.heading }}</h2>
    {% if section.settings.subheading != blank %}
      <p class="pwyc-sub">{{ section.settings.subheading }}</p>
    {% endif %}

    <div class="an-card pwyc-card" id="pwyc-simple-card-{{ section.id }}">
      <!-- Quick tier buttons -->
      <div class="pwyc-quick" role="tablist" aria-label="Quick pricing tiers">
        <button type="button" class="an-btn-secondary pwyc-quick-btn" data-tier="{{ section.settings.min_value }}" data-evt="pwyc_tier_click" data-label="{{ section.settings.min_value }}">{{ section.settings.currency_symbol }}{{ section.settings.min_value }} â€” {{ section.settings.floor_title }}</button>
        <button type="button" class="an-btn-secondary pwyc-quick-btn" data-tier="{{ section.settings.anchor_value }}" data-evt="pwyc_tier_click" data-label="{{ section.settings.anchor_value }}">{{ section.settings.currency_symbol }}{{ section.settings.anchor_value }} â€” {{ section.settings.anchor_title }} <span class="pwyc-badge">{{ section.settings.anchor_badge }}</span></button>
        <button type="button" class="an-btn-secondary pwyc-quick-btn" data-tier="{{ section.settings.max_value }}" data-evt="pwyc_tier_click" data-label="{{ section.settings.max_value }}">{{ section.settings.currency_symbol }}{{ section.settings.max_value }} â€” {{ section.settings.forward_title }}</button>
      </div>

      <!-- Slider -->
      <div class="pwyc-slider-wrap">
        <label id="pwyc-simple-slider-label-{{ section.id }}" class="sr-only" for="pwyc-simple-slider-input-{{ section.id }}">Choose your price</label>
        <input id="pwyc-simple-slider-input-{{ section.id }}" type="range" min="{{ section.settings.min_value }}" max="{{ section.settings.max_value }}" step="1" value="{{ section.settings.default_value }}" class="pwyc-slider" role="slider" aria-orientation="horizontal" aria-labelledby="pwyc-simple-slider-label-{{ section.id }}" aria-valuemin="{{ section.settings.min_value }}" aria-valuemax="{{ section.settings.max_value }}" aria-valuenow="{{ section.settings.default_value }}">
        <div class="pwyc-scale">
          <span>{{ section.settings.currency_symbol }}{{ section.settings.min_value }}</span>
          <span>{{ section.settings.currency_symbol }}{{ section.settings.anchor_value }}</span>
          <span>{{ section.settings.currency_symbol }}{{ section.settings.max_value }}</span>
        </div>
      </div>

      <!-- Readout -->
      <div class="pwyc-readout" id="pwyc-simple-readout-{{ section.id }}" aria-live="polite" aria-atomic="true" role="status">
        <div class="pwyc-price" id="pwyc-simple-price-{{ section.id }}">{{ section.settings.currency_symbol }}{{ section.settings.default_value }}</div>
        <span class="an-chip" id="pwyc-simple-label-{{ section.id }}">{{ section.settings.anchor_badge }}</span>
      </div>
      <p class="pwyc-desc" id="pwyc-simple-desc-{{ section.id }}">{{ section.settings.anchor_desc }}</p>

      <!-- Tier explainer boxes -->
      <div class="pwyc-explainers">
        <div class="pwyc-explainer">
          <div class="pwyc-expl-title">{{ section.settings.currency_symbol }}{{ section.settings.min_value }} â€” {{ section.settings.floor_title }}</div>
          <p>{{ section.settings.floor_desc }}</p>
        </div>
        <div class="pwyc-explainer pwyc-explainer--anchor">
          <div class="pwyc-expl-title">{{ section.settings.currency_symbol }}{{ section.settings.anchor_value }} â€” {{ section.settings.anchor_title }}</div>
          <p>{{ section.settings.anchor_desc }}</p>
        </div>
        <div class="pwyc-explainer">
          <div class="pwyc-expl-title">{{ section.settings.currency_symbol }}{{ section.settings.max_value }} â€” {{ section.settings.forward_title }}</div>
          <p>{{ section.settings.forward_desc }}</p>
        </div>
      </div>

      <!-- CTAs -->
      <div class="pwyc-cta">
        <a id="pwyc-simple-checkout-{{ section.id }}" href="{{ section.settings.checkout_url_anchor }}" class="an-btn-primary" data-evt="pwyc_checkout_click" data-label="slider" aria-describedby="pwyc-simple-desc-{{ section.id }}" aria-label="{{ section.settings.primary_cta_text }} at {{ section.settings.currency_symbol }}{{ section.settings.default_value }}">{{ section.settings.primary_cta_text }} â€” <span id="pwyc-simple-amt-{{ section.id }}">{{ section.settings.currency_symbol }}{{ section.settings.default_value }}</span></a>
        {% if section.settings.show_scholarship %}
          <a href="{{ section.settings.scholarship_link }}" class="an-btn-secondary pwyc-apply" data-evt="pwyc_cta" data-label="scholarship_link">{{ section.settings.scholarship_text }}</a>
        {% endif %}
      </div>

      <div class="pwyc-flags">
        <span>ðŸ”’ Secure checkout</span><span>PayPal accepted</span><span>Instant access</span>
      </div>
    </div>
  </div>

  <style>
    #pwyc-simple-{{ section.id }}{color:var(--c-ink-900);--pwyc-accent: {{ section.settings.anchor_color | default: 'var(--c-brand-600)' }}}
    #pwyc-simple-{{ section.id }} a{color:inherit}
    #pwyc-simple-{{ section.id }} .sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important}
    .pwyc-sub{color:var(--c-ink-500)}
    .pwyc-card{margin-top:16px;padding:16px;border:1px solid var(--border-medium);border-radius:16px}
    .pwyc-quick{display:flex;flex-wrap:wrap;gap:8px}
    .pwyc-quick-btn{border-color:var(--border-medium)!important}
    .pwyc-badge{font-size:11px;margin-left:6px;color:var(--c-ink-500)}
    .pwyc-slider-wrap{margin:16px 0 8px}
    .pwyc-slider{appearance:none;width:100%;height:8px;border-radius:8px;background:#F0EDFF;outline:none}
    .pwyc-slider::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:var(--pwyc-accent);transition:transform var(--duration-fast) var(--motion-ease-standard)}
    .pwyc-slider:active::-webkit-slider-thumb{transform:scale(1.05)}
    .pwyc-slider:focus-visible::-webkit-slider-thumb{box-shadow:0 0 0 4px rgba(94,59,255,0.25)}
    .pwyc-slider::-moz-range-thumb{width:20px;height:20px;border:none;border-radius:50%;background:var(--pwyc-accent)}
    .pwyc-scale{display:flex;justify-content:space-between;font-size:12px;color:var(--c-ink-500);margin-top:6px}
    .pwyc-readout{display:flex;align-items:center;gap:10px;margin:12px 0 8px;padding:8px 10px;border-radius:12px;border:1px solid var(--border-medium)}
    .pwyc-price{font-size:28px;font-weight:700;color:var(--c-ink-900)}
    .pwyc-desc{font-size:.95rem;color:var(--c-ink-700)}
    .pwyc-explainers{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:12px}
    .pwyc-explainer{border:1px solid var(--border-medium);border-radius:12px;padding:12px;background:var(--c-white)}
    .pwyc-explainer--anchor{border:1px solid var(--c-ink-900)}
    .pwyc-expl-title{font-weight:600;color:var(--c-ink-900);margin-bottom:4px}
    .pwyc-cta{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .pwyc-apply{font-size:.9rem;padding:.5rem .75rem;border-color:var(--border-medium)!important}
    #pwyc-simple-{{ section.id }} .an-btn-primary{background:var(--pwyc-accent)!important;border-color:var(--pwyc-accent)!important;color:var(--c-white)!important}
    .pwyc-flags{margin-top:10px;display:flex;flex-wrap:wrap;gap:14px;color:var(--c-ink-500);font-size:.9rem}
    @media (max-width: 900px){.pwyc-explainers{grid-template-columns:1fr}}
    @media (max-width: 600px){.pwyc-cta{flex-direction:column}.pwyc-cta a{width:100%}}
  </style>

  <script>
    (function(){
      var ROOT_ID = 'pwyc-simple-{{ section.id }}';
      function isKajabiModalOpen(){
        try{ return !!document.querySelector('.modal.is-active, .kjb-modal.is-active, .checkout-modal.is-active, [data-behavior*="modal"].is-active'); }catch(e){ return false; }
      }
      function tryCloseKajabiModal(){
        try{
          var closeBtn = document.querySelector('.modal.is-active [data-behavior="modal-close"], .kjb-modal.is-active [data-behavior="modal-close"], .is-active .modal-close, .checkout-modal.is-active .modal-close');
          if(closeBtn){ closeBtn.click(); }
        }catch(e){}
      }
      function initPWYC(){
        var root = document.getElementById(ROOT_ID);
        if(!root || root.dataset.inited === '1') return; root.dataset.inited = '1';
        var slider   = root.querySelector('#pwyc-simple-slider-input-{{ section.id }}');
        var price    = root.querySelector('#pwyc-simple-price-{{ section.id }}');
        var label    = root.querySelector('#pwyc-simple-label-{{ section.id }}');
        var desc     = root.querySelector('#pwyc-simple-desc-{{ section.id }}');
        var checkout = root.querySelector('#pwyc-simple-checkout-{{ section.id }}');
        if(!slider || !price || !label || !desc || !checkout) return;
        var quickButtons = Array.prototype.slice.call(root.querySelectorAll('[data-tier]'));
        var currency   = {{ section.settings.currency_symbol | json }};
        var storageKey = 'pwyc:simple:lastSelected:{{ section.id }}';

        var tiers = [
          { v: {{ section.settings.min_value   | default: 49  }}, key:'floor',   chip: {{ section.settings.floor_title   | json }},   desc: {{ section.settings.floor_desc   | json }},   url: root.dataset.urlFloor   },
          { v: {{ section.settings.anchor_value| default: 297 }}, key:'anchor',  chip: {{ section.settings.anchor_title  | json }},   desc: {{ section.settings.anchor_desc  | json }},   url: root.dataset.urlAnchor  },
          { v: {{ section.settings.max_value   | default: 449 }}, key:'forward', chip: {{ section.settings.forward_title | json }},   desc: {{ section.settings.forward_desc | json }},   url: root.dataset.urlForward }
        ];

        var colors = {
          floor:   {{ section.settings.floor_color   | default: 'var(--c-accent-teal)'  | json }},
          anchor:  {{ section.settings.anchor_color  | default: 'var(--c-brand-600)'    | json }},
          forward: {{ section.settings.forward_color | default: 'var(--c-accent-lemon)' | json }}
        };

        function closestTier(val){
          return tiers.reduce(function(best, t){
            return Math.abs(t.v - val) < Math.abs(best.v - val) ? t : best;
          }, tiers[0]);
        }
        function applyAccentForTier(t){
          try { root.style.setProperty('--pwyc-accent', colors[t.key] || colors.anchor); } catch(e) {}
        }
        function toggleActiveStates(selectedV){
          quickButtons.forEach(function(btn){
            var isActive = parseInt(btn.dataset.tier, 10) === selectedV;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
        }
        function render(t, opts){
          price.textContent = currency + t.v;
          label.textContent = t.chip;
          desc.textContent  = t.desc;
          if(t.url) checkout.href = t.url;
          slider.value = String(t.v);
          slider.setAttribute('aria-valuenow', String(t.v));
          slider.setAttribute('aria-valuetext', currency + t.v + ' â€” ' + t.chip);
          checkout.setAttribute('data-value', String(t.v));
          checkout.setAttribute('aria-label', {{ section.settings.primary_cta_text | json }} + ' at ' + currency + t.v + ' â€” ' + t.chip);
          applyAccentForTier(t);
          toggleActiveStates(t.v);
          try { localStorage.setItem(storageKey, String(t.v)); } catch(e){}
          if(opts && opts.focusCta){
            if(isKajabiModalOpen()) return;
            var prefersReduced = false;
            try { prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; } catch(err){}
            if(prefersReduced){ checkout.focus(); } else { tryCloseKajabiModal(); checkout.scrollIntoView({behavior:'smooth', block:'center'}); }
          }
        }
        function selectByValue(value, source){
          var t = closestTier(parseInt(value,10));
          render(t, { focusCta: source !== 'slider' });
          try { if(window.gtag){ gtag('event','pwyc_tier_click',{ value:t.v, tier_key:t.key, source:source }); } } catch(e){}
          try { if(navigator.vibrate){ navigator.vibrate(8); } } catch(e){}
        }

        var storedVal = (function(){ try{ var v = parseInt(localStorage.getItem(storageKey),10); return isNaN(v) ? null : v; } catch(e){ return null; }})();
        var initial   = closestTier(storedVal != null ? storedVal : parseInt(slider.value,10));
        render(initial);

        // URL preselect (?tier=floor|anchor|forward or ?amount=297)
        try{
          var qp = new URLSearchParams(window.location.search);
          var qpVal = qp.get('tier') || qp.get('pwyc') || qp.get('amount');
          if(qpVal){
            var byKey = tiers.find(function(t){ return t.key === String(qpVal).toLowerCase(); });
            if(byKey) render(byKey); else { var n = parseInt(qpVal,10); if(!isNaN(n)) render(closestTier(n)); }
          }
        }catch(e){}

        slider.addEventListener('input', function(){ selectByValue(slider.value, 'slider'); });
        quickButtons.forEach(function(btn){
          btn.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); selectByValue(btn.dataset.tier, 'button'); });
          btn.addEventListener('keydown', function(e){ var k=e.key||e.code; if(k===' '||k==='Spacebar'||k==='Enter'){ e.preventDefault(); selectByValue(btn.dataset.tier, 'button_kbd'); }});
        });
        checkout.addEventListener('click', function(){ try { localStorage.setItem(storageKey, String(checkout.getAttribute('data-value') || '')); } catch(e) {} });
      }
      if(document.readyState !== 'loading') initPWYC(); else document.addEventListener('DOMContentLoaded', initPWYC);
      document.addEventListener('turbolinks:load', initPWYC);
      document.addEventListener('pageshow', initPWYC);
    })();
  </script>
</section>

{% schema %}
{
  "name": "Pricing - PWYC (Simple)",
  "elements": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Payâ€‘Whatâ€‘Youâ€‘Can (Every Tier Gets Everything)" },
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Choose what honors your financial reality:" },

    { "type": "header", "content": "Tiers & Values" },
    { "type": "text", "id": "currency_symbol", "label": "Currency Symbol", "default": "$" },
    { "type": "range", "id": "min_value", "label": "Floor Value", "min": 1, "max": 1000, "step": 1, "default": 49 },
    { "type": "range", "id": "anchor_value", "label": "Anchor Value", "min": 1, "max": 2000, "step": 1, "default": 297 },
    { "type": "range", "id": "max_value", "label": "Payâ€‘Itâ€‘Forward Value", "min": 1, "max": 5000, "step": 1, "default": 449 },
    { "type": "range", "id": "default_value", "label": "Default Slider Value", "min": 1, "max": 5000, "step": 1, "default": 297 },

    { "type": "header", "content": "Labels & Descriptions" },
    { "type": "text", "id": "floor_title", "label": "Floor Title", "default": "Floor" },
    { "type": "textarea", "id": "floor_desc", "label": "Floor Description", "default": "If money is tight. Full program + lifetime access." },
    { "type": "text", "id": "anchor_title", "label": "Anchor Title", "default": "Anchor" },
    { "type": "text", "id": "anchor_badge", "label": "Anchor Badge", "default": "Most chosen" },
    { "type": "textarea", "id": "anchor_desc", "label": "Anchor Description", "default": "Fair value exchange. What it costs to create/maintain." },
    { "type": "text", "id": "forward_title", "label": "Payâ€‘Itâ€‘Forward Title", "default": "Payâ€‘Itâ€‘Forward" },
    { "type": "textarea", "id": "forward_desc", "label": "Payâ€‘Itâ€‘Forward Description", "default": "If you're able. Funds 1/3 scholarship seat. Every 3 = 1 full scholarship." },

    { "type": "header", "content": "CTA & Links" },
    { "type": "text", "id": "primary_cta_text", "label": "Primary CTA Text", "default": "Checkout" },
    { "type": "action", "id": "checkout_url_floor", "label": "Checkout URL â€” Floor", "default": "/checkout/spp-49" },
    { "type": "action", "id": "checkout_url_anchor", "label": "Checkout URL â€” Anchor", "default": "/checkout/spp-297" },
    { "type": "action", "id": "checkout_url_forward", "label": "Checkout URL â€” Payâ€‘Itâ€‘Forward", "default": "/checkout/spp-449" },

    { "type": "header", "content": "Tier Colors" },
    { "type": "text", "id": "floor_color", "label": "Floor Color (CSS value)", "default": "var(--c-accent-teal)" },
    { "type": "text", "id": "anchor_color", "label": "Anchor Color (CSS value)", "default": "var(--c-brand-600)" },
    { "type": "text", "id": "forward_color", "label": "Payâ€‘Itâ€‘Forward Color (CSS value)", "default": "var(--c-accent-lemon)" },

    { "type": "header", "content": "Scholarship/Support" },
    { "type": "checkbox", "id": "show_scholarship", "label": "Show Scholarship Link", "default": true },
    { "type": "text", "id": "scholarship_text", "label": "Scholarship Link Text", "default": "Request scholarship" },
    { "type": "action", "id": "scholarship_link", "label": "Scholarship Link", "default": "#" }
  ],
  "presets": [
    { "name": "Pricing - PWYC (Simple)", "category": "Offers & Pricing" }
  ]
}
{% endschema %}


