{% comment %}
  Media — Portrait-friendly Video (Shared)
  - Maintains true portrait aspect-ratios via CSS aspect-ratio
  - Works with iframe embeds (YouTube/Vimeo/Wistia) or direct <video> sources
  - Optional caption and max-width; responsive and accessible
  - Avoids cropping; iframes will letterbox per provider behavior
{% endcomment %}

{% assign s_id = section.id %}
{% assign dom_id = section.settings.section_id | default: 'portrait-video' %}

{% assign ar = section.settings.aspect_ratio | default: '9 / 16' %}
{% assign bg = section.settings.background | default: 'var(--c-ink-950, #0d1321)' %}
{% assign radius = section.settings.radius_px | default: 16 %}
{% assign maxw = section.settings.max_width | default: 520 %}
{% assign align = section.settings.align | default: 'center' %}
{% assign show_caption = section.settings.show_caption %}

{% assign source_type = section.settings.source_type | default: 'iframe' %}
{% assign autoplay = section.settings.autoplay %}
{% assign muted = section.settings.muted %}
{% assign loop = section.settings.loop %}
{% assign controls = section.settings.controls %}
{% assign playsinline = section.settings.playsinline %}
{% assign poster = section.settings.poster %}
{% assign poster_image = section.settings.poster_image %}
{% assign kjb_video = section.settings.kjb_video %}
{% assign video_src = section.settings.file_url %}
{% assign poster_src = '' %}
{% if poster_image != blank %}
  {% assign poster_src = poster_image | image_picker_url: 'master' %}
{% elsif poster != blank %}
  {% assign poster_src = poster %}
{% endif %}

<section id="{{ dom_id }}-{{ s_id }}" class="an-section an-theme an-white portrait-video">
  <div class="pv-wrap {{ align }} an-reveal">
    <div class="pv-media" role="region" aria-label="Video">
      {% if source_type == 'kajabi' and kjb_video != blank %}
        <iframe class="pv-el" src="https://fast.wistia.net/embed/iframe/{{ kjb_video.wistia_id }}?videoFoam=true{% if autoplay %}&autoPlay=true{% endif %}"
                title="Kajabi video" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      {% elsif source_type == 'file' %}
        <video class="pv-el" {% if controls %}controls{% endif %} {% if autoplay %}autoplay{% endif %} {% if muted %}muted{% endif %} {% if loop %}loop{% endif %} {% if playsinline %}playsinline{% endif %} {% if poster_src != blank %}poster="{{ poster_src }}"{% endif %}>
          {% if video_src != blank %}<source src="{{ video_src }}" />{% endif %}
        </video>
      {% else %}
        {% assign src = section.settings.embed_url %}
        {% if src == blank %}
          {% comment %}Sensible default to visualize in editor{% endcomment %}
          {% assign src = 'https://player.vimeo.com/video/76979871?title=0&byline=0&portrait=0&dnt=1' %}
        {% endif %}
        <iframe class="pv-el" src="{{ src }}" title="Embedded video" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      {% endif %}
    </div>

    {% if show_caption and section.settings.caption != blank %}
      <p class="pv-cap">{{ section.settings.caption }}</p>
    {% endif %}
  </div>

  <style>
    #{{ dom_id }}-{{ s_id }}.portrait-video{position:relative; --px: {{ section.settings.pad_x | default: 20 }}px}
    #{{ dom_id }}-{{ s_id }} .pv-wrap{max-width:{{ maxw }}px; margin:0 auto; padding:var(--px)}
    #{{ dom_id }}-{{ s_id }} .pv-wrap.left{margin-left:0}
    #{{ dom_id }}-{{ s_id }} .pv-wrap.right{margin-right:0}

    #{{ dom_id }}-{{ s_id }} .pv-media{position:relative; width:100%; aspect-ratio: {{ ar }}; background: {{ bg }}; border-radius: {{ radius }}px; overflow:hidden; box-shadow: 0 8px 28px rgba(0,0,0,.12)}
    #{{ dom_id }}-{{ s_id }} .pv-el{position:absolute; inset:0; width:100%; height:100%; display:block; border:0; background:transparent; object-fit: {{ section.settings.object_fit | default: 'contain' }} }

    #{{ dom_id }}-{{ s_id }} .pv-cap{margin:.6rem 0 0; text-align:center; color:var(--c-ink-700, #4a5165); font-size:clamp(13px, 2.2vw, 16px)}

    @media (max-width:700px){
      #{{ dom_id }}-{{ s_id }} .pv-wrap{max-width: min({{ maxw }}px, 92vw)}
    }
  </style>

  <script>
    (function(){
      document.documentElement.classList.add('an-js');
      var root = document.getElementById('{{ dom_id }}-{{ s_id }}');
      if(!root || root.dataset.inited==='1') return; root.dataset.inited='1';
      var items = [].slice.call(root.querySelectorAll('.an-reveal'));
      function show(){ items.forEach(function(n){ n.classList.add('is-in'); }); }
      var inEditor = location.search.indexOf('preview')>-1 || !!document.querySelector('[data-kajabi-theme-editor],[data-builder],[data-editor]');
      if('IntersectionObserver' in window && !inEditor){
        var io = new IntersectionObserver(function(entries){ entries.forEach(function(e){ if(e.isIntersecting){ e.target.classList.add('is-in'); io.unobserve(e.target);} }); }, {threshold:.2});
        items.forEach(function(n){ io.observe(n); });
        setTimeout(show, 1400);
      } else { show(); }
    })();
  </script>
</section>

{% schema %}
{
  "name": "Media — Portrait Video",
  "elements": [
    { "type": "text", "id": "section_id", "label": "Section ID", "default": "portrait-video" },

    { "type": "select", "id": "source_type", "label": "Source type", "default": "iframe", "options": [
      { "value": "iframe", "label": "Embed (YouTube/Vimeo/Wistia iframe)" },
      { "value": "kajabi", "label": "Kajabi video (native picker)" },
      { "value": "file", "label": "Direct file (<video> tag)" }
    ]},
    { "type": "video", "id": "kjb_video", "label": "Kajabi Video" },
    { "type": "text", "id": "embed_url", "label": "Embed URL (YouTube/Vimeo/Wistia)", "default": "https://player.vimeo.com/video/76979871?title=0&byline=0&portrait=0&dnt=1" },
    { "type": "text", "id": "file_url", "label": "Video file URL (mp4, webm)", "default": "", "info": "Upload the video in Kajabi Settings → Files, then copy its URL and paste here." },
    { "type": "text", "id": "poster", "label": "Poster image URL (optional)", "default": "" },
    { "type": "image_picker", "id": "poster_image", "label": "Poster image (picker)" },

    { "type": "select", "id": "aspect_ratio", "label": "Aspect ratio", "default": "9 / 16", "options": [
      { "value": "9 / 16", "label": "Portrait — 9:16" },
      { "value": "2 / 3", "label": "Portrait — 2:3" },
      { "value": "3 / 4", "label": "Portrait — 3:4" },
      { "value": "4 / 5", "label": "Portrait — 4:5" },
      { "value": "1 / 1", "label": "Square — 1:1" },
      { "value": "16 / 9", "label": "Landscape — 16:9" }
    ]},
    { "type": "range", "id": "radius_px", "label": "Corner radius (px)", "default": 16, "min": 0, "max": 40, "step": 1 },
    { "type": "range", "id": "max_width", "label": "Max width (px)", "default": 520, "min": 320, "max": 1200, "step": 10 },
    { "type": "select", "id": "align", "label": "Alignment", "default": "center", "options": [
      { "value": "left", "label": "Left" },
      { "value": "center", "label": "Center" },
      { "value": "right", "label": "Right" }
    ]},
    { "type": "text", "id": "background", "label": "Player background", "default": "#0d1321" },
    { "type": "text", "id": "object_fit", "label": "Video fit (video tag only: contain|cover)", "default": "contain" },
    { "type": "range", "id": "pad_x", "label": "Side padding (px)", "default": 20, "min": 0, "max": 80, "step": 2 },

    { "type": "checkbox", "id": "controls", "label": "Show controls (video tag)", "default": true },
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay (muted recommended)", "default": false },
    { "type": "checkbox", "id": "muted", "label": "Muted", "default": true },
    { "type": "checkbox", "id": "loop", "label": "Loop", "default": false },
    { "type": "checkbox", "id": "playsinline", "label": "Plays inline (iOS)", "default": true },

    { "type": "checkbox", "id": "show_caption", "label": "Show caption", "default": false },
    { "type": "text", "id": "caption", "label": "Caption text", "default": "" }
  ],
  "blocks": [],
  "presets": [
    {
      "name": "Media — Portrait Video",
      "category": "Media",
      "settings": {
        "source_type": "iframe",
        "embed_url": "https://player.vimeo.com/video/76979871?title=0&byline=0&portrait=0&dnt=1",
        "aspect_ratio": "9 / 16",
        "radius_px": 16,
        "max_width": 520,
        "align": "center",
        "background": "#0d1321",
        "object_fit": "contain",
        "controls": true,
        "muted": true,
        "playsinline": true
      }
    }
  ]
}
{% endschema %}
