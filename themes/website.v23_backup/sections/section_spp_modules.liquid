{% if section.settings.section_id != blank %}<a id="{{ section.settings.section_id | escape }}"></a>{% endif %}
<section id="{{ section.settings.section_id | default: 'spp-modules' }}-{{ section.id }}" class="spp-modules py-6" style="background: linear-gradient(180deg, #FFFFFF 0%, var(--c-brand-50, #F7FAFF) 100%); --week-grad-start: {{ section.settings.accent_start | default: '#6366F1' }}; --week-grad-end: {{ section.settings.accent_end | default: '#8B5CF6' }}; --dot-color: {{ section.settings.dot_color | default: 'var(--c-accent-violet, #8B5CF6)' }}; --card-bg: {{ section.settings.card_bg | default: '#FFFFFF' }}; --card-border: {{ section.settings.card_border | default: 'rgba(0,0,0,0.06)' }}; --pill-bg: {{ section.settings.pill_bg | default: 'var(--c-brand-50, #F3F6FF)' }}; --card-max-width: {{ section.settings.card_max_width | default: '860px' }}; --week-title-size: {{ section.settings.week_title_size | default: '24px' }};">
  <style>
    .spp-modules .eyebrow { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background: var(--c-brand-100); color: var(--c-ink-900); font-weight:600; font-size:12px; }
    .spp-modules .intro { max-width: 900px; }
    .spp-modules .timeline { position: relative; }
    .spp-modules .week-card { position: relative; background: var(--wk-card-bg, var(--card-bg)); border-radius:16px; padding:28px; box-shadow:0 24px 70px rgba(0,0,0,0.08); border:1px solid var(--card-border); transition: transform .25s ease, box-shadow .25s ease; max-width: var(--card-max-width); margin-inline: auto; }
    .spp-modules .week-card + .week-gap { height: 40px; }
    .spp-modules .week-card:hover { transform: translateY(-2px); box-shadow:0 28px 80px rgba(0,0,0,0.1); }
    .spp-modules .week-head { display:flex; align-items:center; gap:14px; margin-bottom:8px; }
    .spp-modules .week-num { width:46px; height:46px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; background: linear-gradient(90deg, var(--week-grad-start), var(--week-grad-end)); box-shadow:0 10px 30px rgba(99,102,241,.35); flex:0 0 46px; letter-spacing: -0.02em; }
    .spp-modules .week-title { margin:0; font-size: var(--week-title-size); color: var(--wk-title-color, var(--c-ink-900)); font-weight:800; letter-spacing:-0.01em; }
    .spp-modules .week-sub { margin:4px 0 0; color: var(--wk-sub-color, var(--c-ink-600)); font-style: italic; }
    .spp-modules .week-card.header-bg .week-head { background: var(--wk-header-bg, var(--pill-bg)); padding: 12px 14px; border-radius: 14px; }
    .spp-modules .cols { display:grid; grid-template-columns: 1fr; gap:18px; margin-top:16px; }
    @media (min-width: 992px) { .spp-modules .cols { grid-template-columns: 1fr 1fr; } }
    .spp-modules .label { font-weight:700; color: var(--c-ink-900); margin-bottom:6px; }
    .spp-modules .muted { color: var(--c-ink-700); }
    .spp-modules .pill { display:inline-block; padding:10px 12px; background: var(--pill-bg); border-radius:10px; margin-bottom:8px; color: var(--c-ink-800); }
    .spp-modules ul.dot { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .spp-modules ul.dot li { position: relative; padding-left:16px; color: var(--c-ink-800); }
    .spp-modules ul.dot li::before { content:""; position:absolute; left:0; top:10px; width:8px; height:8px; background: var(--dot-color); border-radius:50%; }

    /* Sticky progress nav */
    .spp-modules .progress-nav { position: sticky; top: 100px; display:none; }
    @media (min-width: 1200px) { .spp-modules .progress-nav { display:block; } }
    .spp-modules .progress-list { position:relative; padding-left:20px; }
    .spp-modules .progress-list::before { content:""; position:absolute; left:9px; top:0; bottom:0; width:2px; background: var(--c-brand-200, #E5E7FF); }
    .spp-modules .progress-item { display:flex; align-items:center; gap:10px; margin-bottom:16px; color: var(--c-ink-700); text-decoration:none; }
    .spp-modules .progress-dot { width:20px; height:20px; border-radius:50%; background: var(--c-brand-200, #E5E7FF); display:inline-flex; align-items:center; justify-content:center; color:#fff; font-size:12px; font-weight:700; transition: all .2s; }
    .spp-modules .progress-item.is-active .progress-dot { background: var(--c-brand-600, #3B82F6); transform: scale(1.1); }
    .spp-modules .progress-item .label { font-weight:600; color: var(--c-ink-700); }

    /* Active state */
    .spp-modules .week-card.is-active { outline: 2px solid var(--c-brand-300, #C7D2FE); }
  </style>

  <div class="container">
    <div class="intro text-center mb-5 mx-auto">
      {% if section.settings.eyebrow != blank %}
        <div class="eyebrow mb-2" kjb-settings-id="{{ 'eyebrow' | settings_id: section: section }}">{{ section.settings.eyebrow }}</div>
      {% endif %}
      <h2 class="mb-2" style="font-size: var(--fs-h1); color: var(--c-ink-900); font-weight: 800; letter-spacing: -0.01em;" kjb-settings-id="{{ 'heading' | settings_id: section: section }}">{{ section.settings.heading | default: 'Program Roadmap — Your Transformation' }}</h2>
      {% if section.settings.subheading != blank %}
        <p class="mx-auto" style="max-width: 720px; font-size: var(--fs-body-lg); color: var(--c-ink-700);" kjb-settings-id="{{ 'subheading' | settings_id: section: section }}">{{ section.settings.subheading }}</p>
      {% endif %}
    </div>

    <div class="row g-5">
      {% if section.settings.show_progress_nav %}
        <div class="col-xl-3">
          <div class="progress-nav" aria-hidden="true">
            <div class="progress-list">
              {% for block in section.blocks %}
                {% if block.type == 'week' %}
                  <a href="#week-{{ forloop.index }}-{{ section.id }}" class="progress-item" data-week-link="{{ forloop.index }}">
                    <span class="progress-dot">{{ forloop.index }}</span>
                    <span class="label">{{ block.settings.short_label | default: block.settings.title | default: 'Week ' | append: forloop.index }}</span>
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      <div class="{% if section.settings.show_progress_nav %}col-xl-9{% else %}col-xl-12{% endif %} timeline">
        {% assign week_index = 0 %}
        {% for block in section.blocks %}
          {% if block.type == 'week' %}
            {% assign week_index = week_index | plus: 1 %}
            {% assign style_parts = '' %}
            {% if block.settings.bg_apply == 'card' and block.settings.bg_color != blank %}
              {% assign style_parts = style_parts | append: '--wk-card-bg:' | append: block.settings.bg_color | append: ';' %}
            {% endif %}
            {% if block.settings.bg_apply == 'header' and block.settings.bg_color != blank %}
              {% assign style_parts = style_parts | append: '--wk-header-bg:' | append: block.settings.bg_color | append: ';' %}
            {% endif %}
            {% if block.settings.title_color != blank %}
              {% assign style_parts = style_parts | append: '--wk-title-color:' | append: block.settings.title_color | append: ';' %}
            {% endif %}
            {% if block.settings.subtitle_color != blank %}
              {% assign style_parts = style_parts | append: '--wk-sub-color:' | append: block.settings.subtitle_color | append: ';' %}
            {% endif %}
            <div id="week-{{ week_index }}-{{ section.id }}" class="week-card{% if block.settings.bg_apply == 'header' %} header-bg{% endif %}" data-week-card="{{ week_index }}"{% if style_parts != '' %} style="{{ style_parts }}"{% endif %}>
              <div class="week-head">
                <div class="week-num">{{ week_index }}</div>
                <div>
                  <h3 class="week-title" kjb-settings-id="{{ 'title' | settings_id: block: block }}">{{ block.settings.title | default: 'Module title' }}</h3>
                  {% if block.settings.subtitle != blank %}
                    <div class="week-sub" kjb-settings-id="{{ 'subtitle' | settings_id: block: block }}">{{ block.settings.subtitle }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="cols">
                <div>
                  <div class="label">{{ block.settings.breakthrough_label | default: 'The breakthrough:' }}</div>
                  {% if block.settings.breakthrough != blank %}
                    <p class="muted" kjb-settings-id="{{ 'breakthrough' | settings_id: block: block }}">{{ block.settings.breakthrough }}</p>
                  {% endif %}

                  <div class="label mt-3">{{ block.settings.practice_label | default: "What you'll practice:" }}</div>
                  {% assign list = block.settings.practice | newline_to_br | split: '<br />' %}
                  <ul class="dot">
                    {% for item in list %}
                      {% assign trimmed = item | strip %}
                      {% if trimmed != '' %}<li>{{ trimmed }}</li>{% endif %}
                    {% endfor %}
                  </ul>
                </div>

                <div>
                  <div class="label">{{ block.settings.scripts_label | default: "Sample scripts you'll master:" }}</div>
                  {% assign scripts = block.settings.scripts | newline_to_br | split: '<br />' %}
                  {% for s in scripts %}
                    {% assign st = s | strip %}
                    {% if st != '' %}<div class="pill">“{{ st }}”</div>{% endif %}
                  {% endfor %}

                  {% if block.settings.scenarios != blank %}
                    <div class="label mt-3">{{ block.settings.scenarios_label | default: "Real scenarios you'll handle:" }}</div>
                    <div class="muted" kjb-settings-id="{{ 'scenarios' | settings_id: block: block }}">{{ block.settings.scenarios }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="week-gap"></div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    (function(){
      try {
        var sectionEl = document.currentScript.closest('section');
        var cards = sectionEl.querySelectorAll('[data-week-card]');
        var links = sectionEl.querySelectorAll('[data-week-link]');
        if (!('IntersectionObserver' in window)) return;
        var io = new IntersectionObserver(function(entries){
          entries.forEach(function(e){
            var idx = e.target.getAttribute('data-week-card');
            var link = sectionEl.querySelector('[data-week-link="' + idx + '"]');
            if (e.isIntersecting && e.intersectionRatio > 0) {
              e.target.classList.add('is-active');
              if (link) link.classList.add('is-active');
            } else {
              e.target.classList.remove('is-active');
              if (link) link.classList.remove('is-active');
            }
          });
        }, { rootMargin: '-40% 0px -50% 0px', threshold: [0, .1, .25, .5, 1] });
        cards.forEach(function(c){ io.observe(c); });
      } catch(err) { /* noop */ }
    })();
  </script>
</section>

{% schema %}
{
  "name": "SPP Modules (Timeline)",
  "elements": [
    {"type": "header", "content": "General"},
    {"type": "text", "id": "section_id", "label": "Section ID", "default": "spp-modules"},
    {"type": "text", "id": "eyebrow", "label": "Eyebrow", "default": "Program Roadmap"},
    {"type": "text", "id": "heading", "label": "Heading", "default": "Your 6‑Week Transformation"},
    {"type": "textarea", "id": "subheading", "label": "Subheading"},
    {"type": "checkbox", "id": "show_progress_nav", "label": "Show left progress timeline", "default": false},
    {"type": "header", "content": "Design Overrides"},
    {"type": "color", "id": "accent_start", "label": "Accent gradient start", "default": "#6366F1"},
    {"type": "color", "id": "accent_end", "label": "Accent gradient end", "default": "#8B5CF6"},
    {"type": "color", "id": "dot_color", "label": "List dot color", "default": "#8B5CF6"},
    {"type": "color", "id": "card_bg", "label": "Card background", "default": "#FFFFFF"},
    {"type": "color", "id": "card_border", "label": "Card border color", "default": "rgba(0,0,0,0.06)"},
    {"type": "color", "id": "pill_bg", "label": "Script pill background", "default": "#F3F6FF"},
    {"type": "text", "id": "card_max_width", "label": "Card max width (e.g. 860px)", "default": "860px"},
    {"type": "text", "id": "week_title_size", "label": "Week title size", "default": "24px"}
  ],
  "blocks": [
    {
      "type": "week",
      "name": "Week / Module",
      "elements": [
        {"type": "text", "id": "short_label", "label": "Short label (progress nav)"},
        {"type": "text", "id": "title", "label": "Title", "default": "Cracking the Attachment Code"},
        {"type": "text", "id": "subtitle", "label": "Subtitle", "default": "Understanding why certain behaviors push YOUR specific buttons"},
        {"type": "header", "content": "Colors"},
        {"type": "select", "id": "bg_apply", "label": "Apply background to", "default": "none", "options": [
          {"label": "None", "value": "none"},
          {"label": "Entire card", "value": "card"},
          {"label": "Header only (title/subtitle)", "value": "header"}
        ]},
        {"type": "color", "id": "bg_color", "label": "Background color"},
        {"type": "color", "id": "title_color", "label": "Title color"},
        {"type": "color", "id": "subtitle_color", "label": "Subtitle color"},
        {"type": "text", "id": "breakthrough_label", "label": "Breakthrough label", "default": "The breakthrough:"},
        {"type": "textarea", "id": "breakthrough", "label": "Breakthrough copy", "default": "You'll identify your attachment pattern and your child's likely pattern, then spot the 'moment before the snap' sooner."},
        {"type": "text", "id": "practice_label", "label": "Practice label", "default": "What you'll practice:"},
        {"type": "textarea", "id": "practice", "label": "Practice list (one per line)", "default": "The 5‑minute neural reset to bring your thinking brain back online\nRecognizing early warning signals (hot, tight, tunnel vision)\nBreaking the 'reactive loop' before it hijacks your day"},
        {"type": "text", "id": "scripts_label", "label": "Scripts label", "default": "Sample scripts you'll master:"},
        {"type": "textarea", "id": "scripts", "label": "Scripts (one per line)", "default": "I'm noticing I'm getting hot and tight. I'm going to breathe and then come back.\nYou're not in trouble. We're figuring out what your body needs.\nThis is hard AND we can handle it together."},
        {"type": "text", "id": "scenarios_label", "label": "Scenarios label", "default": "Real scenarios you'll handle:"},
        {"type": "textarea", "id": "scenarios", "label": "Scenarios (free text / links)"}
      ]
    }
  ],
  "presets": [
    {
      "name": "SPP Modules (Timeline)",
      "category": "Content",
      "blocks": [
        {"type": "week"},
        {"type": "week"},
        {"type": "week"}
      ]
    }
  ]
}
{% endschema %}
