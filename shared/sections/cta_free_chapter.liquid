<section class="sa-free-chapter-cta py-5" style="background: var(--c-ink-900);">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="text-center animate-fade-up">
          <!-- Icon -->
          <div class="mb-4">
            <div style="width: 80px; height: 80px; background: var(--c-accent-teal); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
            </div>
          </div>
          
          <h2 class="mb-3" style="font-size: var(--fs-h1); color: white; font-weight: 500;" kjb-settings-id="{{ 'heading' | settings_id: section: section }}">
            {{ section.settings.heading | default: 'Start Your Journey Today' }}
          </h2>
          
          <p class="mb-4" style="font-size: var(--fs-body-lg); color: rgba(255,255,255,0.9); max-width: 600px; margin: 0 auto;" kjb-settings-id="{{ 'subheading' | settings_id: section: section }}">
            {{ section.settings.subheading | default: 'Download a free chapter and discover how Securely Attached can transform your relationships' }}
          </p>
          
          <!-- Form -->
          <div class="mt-4" style="max-width: 500px; margin: 0 auto;">
            <form action="{{ section.settings.form_action }}" method="post" class="sa-chapter-form d-flex flex-column flex-sm-row gap-3" data-form-type="free-chapter">
              <input type="email" 
                     name="email" 
                     placeholder="{{ section.settings.email_placeholder | default: 'Enter your email' }}"
                     required
                     aria-label="Email address"
                     aria-required="true"
                     aria-describedby="chapter-error-{{ section.id }}"
                     class="form-control sa-email-input"
                     style="background: white; border: 2px solid transparent; padding: 16px 24px; border-radius: 100px; font-size: 16px; transition: all 0.3s ease;">
              
              <button type="submit" 
                      class="btn sa-submit-btn"
                      style="background: var(--c-accent-teal); color: white; padding: 16px 32px; border-radius: 100px; font-weight: 600; white-space: nowrap; border: none; transition: all 0.3s ease;">
                {{ section.settings.button_text | default: 'Get Free Chapter' }}
              </button>
            </form>
            
            <!-- Form Messages -->
            <div class="sa-form-messages mt-3">
              <div class="sa-form-success" style="display: none;">
                <div style="background: rgba(24, 213, 228, 0.2); border-radius: 8px; padding: 12px 20px; display: inline-flex; align-items: center; gap: 8px;">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="9" fill="var(--c-accent-teal)"/>
                    <path d="M14 7L8.5 12.5L6 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span style="color: white; font-size: 14px;">{{ section.settings.success_message }}</span>
                </div>
              </div>
              <div class="sa-form-error" id="chapter-error-{{ section.id }}" style="display: none;">
                <div style="background: rgba(255, 107, 107, 0.2); border-radius: 8px; padding: 12px 20px; display: inline-flex; align-items: center; gap: 8px;">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="9" fill="#FF6B6B"/>
                    <path d="M10 6V10M10 14H10.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span style="color: white; font-size: 14px;" class="error-message">Please enter a valid email address</span>
                </div>
              </div>
            </div>
            
            <p class="mt-3 mb-0" style="font-size: 14px; color: rgba(255,255,255,0.6);">
              {{ section.settings.privacy_text | default: 'We respect your privacy. Unsubscribe at any time.' }}
            </p>
          </div>
          
          <!-- Benefits -->
          <div class="mt-5 pt-4" style="border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="row g-4 text-center">
              {% for block in section.blocks %}
                {% if block.type == 'benefit' %}
                  <div class="col-md-4 animate-fade-up" style="animation-delay: {{ forloop.index | times: 0.1 }}s;">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--c-accent-teal)">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                      </svg>
                    </div>
                    <p class="mb-0" style="color: rgba(255,255,255,0.8); font-size: 14px;" kjb-settings-id="{{ 'text' | settings_id: section: section, block: block }}">
                      {{ block.settings.text }}
                    </p>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
/* Form validation states */
.sa-email-input.error {
  border-color: #FF6B6B !important;
  background: rgba(255, 107, 107, 0.05) !important;
}

.sa-email-input:focus {
  outline: none;
  border-color: var(--c-accent-teal) !important;
  box-shadow: 0 0 0 4px rgba(24, 213, 228, 0.2);
}

/* Button states */
.sa-submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(24, 213, 228, 0.4);
}

.sa-submit-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

/* Message animations */
.sa-form-messages > div > div {
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('#shopify-section-{{ section.id }}');
    const form = section.querySelector('.sa-chapter-form');
    const emailInput = section.querySelector('.sa-email-input');
    const submitBtn = section.querySelector('.sa-submit-btn');
    const successMsg = section.querySelector('.sa-form-success');
    const errorMsg = section.querySelector('.sa-form-error');
    const errorText = errorMsg.querySelector('.error-message');
    const originalBtnText = submitBtn.textContent;

    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // Validate email
    const validateEmail = (email) => {
      const value = email.trim();
      if (!value) {
        return { valid: false, message: 'Please enter your email address' };
      }
      if (!emailRegex.test(value)) {
        return { valid: false, message: 'Please enter a valid email address' };
      }
      return { valid: true };
    };

    // Show error
    const showError = (message) => {
      errorText.textContent = message;
      errorMsg.style.display = 'block';
      successMsg.style.display = 'none';
      emailInput.classList.add('error');
      emailInput.setAttribute('aria-invalid', 'true');
    };

    // Hide messages
    const hideMessages = () => {
      successMsg.style.display = 'none';
      errorMsg.style.display = 'none';
      emailInput.classList.remove('error');
      emailInput.setAttribute('aria-invalid', 'false');
    };

    // Real-time validation
    emailInput.addEventListener('blur', function() {
      const validation = validateEmail(this.value);
      if (!validation.valid && this.value.trim() !== '') {
        showError(validation.message);
      } else {
        hideMessages();
      }
    });

    // Clear error on input
    emailInput.addEventListener('input', function() {
      if (this.classList.contains('error')) {
        hideMessages();
      }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Hide messages
      hideMessages();
      
      // Validate
      const validation = validateEmail(emailInput.value);
      if (!validation.valid) {
        showError(validation.message);
        emailInput.focus();
        return;
      }
      
      // Loading state
      submitBtn.textContent = 'Sending...';
      submitBtn.disabled = true;
      emailInput.disabled = true;
      
      // Simulate submission
      setTimeout(function() {
        // Show success
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
        
        // Reset form
        form.reset();
        
        // Reset button
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
        emailInput.disabled = false;
        
        // Scroll to success
        successMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Analytics event (if available)
        if (typeof gtag !== 'undefined') {
          gtag('event', 'free_chapter_download', {
            'event_category': 'Lead Generation',
            'event_label': 'SA Free Chapter'
          });
        }
      }, 1500);
    });
  });
</script>

{% schema %}
{
  "name": "CTA - Free Chapter",
  "elements": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Start Your Journey Today"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "form_action",
      "label": "Form Action URL"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email Placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Get Free Chapter"
    },
    {
      "type": "text",
      "id": "privacy_text",
      "label": "Privacy Text"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "Success! Check your email for the free chapter ðŸ“§"
    }
  ],
  "blocks": [
    {
      "type": "benefit",
      "name": "CTA - Free Chapter",
      "elements": [
        {
          "type": "text",
          "id": "text",
          "label": "Benefit Text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "CTA - Free Chapter",
      "category": "Content",
      "blocks": [
        {
          "type": "benefit",
          "settings": {
            "text": "Instant download"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "text": "Sample prompts included"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "text": "No credit card required"
          }
        }
      ]
    }
  ]
}
{% endschema %}