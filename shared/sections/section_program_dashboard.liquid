{% comment %}
  Secure Parenting Program — Dashboard Tabs (Shared)
  Tabs: Modules | Printables | Q&A
  Focus: Printables grid with per-card image + color overlay controls.
{% endcomment %}

{% assign sid = section.id %}

<section id="program-dashboard-{{ sid }}" class="an-section an-theme">
  <div class="pd-wrap">
    {% if section.settings.heading or section.settings.subheading %}
      <header class="pd-head">
        {% if section.settings.heading %}<h2 class="pd-title">{{ section.settings.heading }}</h2>{% endif %}
        {% if section.settings.subheading %}<p class="pd-sub">{{ section.settings.subheading }}</p>{% endif %}
      </header>
    {% endif %}

    <!-- Tabs -->
    <div class="pd-tabs" role="tablist" aria-label="Secure Parenting Program">
      <button class="pd-tab is-active" role="tab" id="pd-tab-mod-{{ sid }}" aria-controls="pd-panel-mod-{{ sid }}" aria-selected="true">{{ section.settings.tab_label_modules }}</button>
      <button class="pd-tab" role="tab" id="pd-tab-prn-{{ sid }}" aria-controls="pd-panel-prn-{{ sid }}" aria-selected="false">{{ section.settings.tab_label_printables }}</button>
      <button class="pd-tab" role="tab" id="pd-tab-qa-{{ sid }}" aria-controls="pd-panel-qa-{{ sid }}" aria-selected="false">{{ section.settings.tab_label_qa }}</button>
    </div>

    <!-- Panels -->
    <div id="pd-panel-mod-{{ sid }}" class="pd-panel is-active" role="tabpanel" aria-labelledby="pd-tab-mod-{{ sid }}">
      {% if section.blocks.size > 0 %}
      <div class="pdm-grid" style="gap: {{ section.settings.grid_gap }}px;">
        {% for block in section.blocks %}
          {% assign tab_select = block.settings.tab | default: '' %}
          {% assign show_this = false %}
          {% if tab_select == 'mod' %}
            {% assign show_this = true %}
          {% elsif tab_select == '' %}
            {% if block.type == 'module' %}
              {% assign show_this = true %}
            {% endif %}
          {% endif %}
          {% if show_this %}
          {% assign icon = block.settings.emoji | default: '🔒' %}
          <article class="pdm-card" {{ block.shopify_attributes }} style="--pdm-tint-color: {{ block.settings.mod_tint_color | default: section.settings.modules_tint_color }}; --pdm-tint-o: {{ block.settings.mod_tint_opacity | default: section.settings.modules_tint_opacity | times: 0.01 }};" data-status="{{ block.settings.status | default: 'none' }}">
            <a href="{{ block.settings.url | default: '#' }}" class="pdm-link" aria-label="{{ block.settings.cta_text | default: 'Open module' }}: {{ block.settings.title | escape }}" {% if block.settings.new_tab %}target="_blank" rel="noopener noreferrer"{% endif %}>
              <div class="pdm-media" aria-hidden="true" data-bg-sm="{{ block.settings.mod_background | image_picker_url: '800x600' }}" data-bg-lg="{{ block.settings.mod_background | image_picker_url: '1600x900' }}"></div>
              <div class="pdm-body{% if section.settings.enable_text_contrast %} has-contrast{% endif %}" style="--text-contrast-o: {{ section.settings.text_contrast_opacity | default: 35 | times: 0.01 }}">
                <!-- Simplified: removed module badge to avoid duplication/clutter -->
                {% unless block.settings.status == 'none' %}
                  <span class="pdm-status">
                    {% case block.settings.status %}
                      {% when 'complete' %}Complete{% when 'in_progress' %}In Progress{% else %}{{ block.settings.status }}{% endcase %}
                  </span>
                {% endunless %}
                {% assign week_text = block.settings.week_label | default: '' | strip %}
                {% assign kicker_text = block.settings.kicker | default: '' | strip %}
                {% assign label = kicker_text %}
                {% if label == '' %}{% assign label = week_text %}{% endif %}
                {% if label != '' %}
                  <div class="pdm-chip">{{ label }}</div>
                {% endif %}
                <h3 class="pdm-title">{{ block.settings.title | default: 'Module title' }}</h3>
                <div class="pdm-meta">
                  {% if block.settings.duration != blank %}
                    {% include "icon", icon: 'clock', size: 16, color: 'currentColor', aria_label: '' %} {{ block.settings.duration }}
                  {% endif %}
                </div>
                {% if block.settings.cta_text != blank %}<div class="pdm-cta">{{ block.settings.cta_text }}</div>{% endif %}
              </div>
            </a>
          </article>
          {% endif %}
        {% endfor %}
      </div>
      {% else %}
        {% if section.settings.modules_embed != blank %}
          {{ section.settings.modules_embed }}
        {% else %}
          <p class="pd-note">Add Module blocks below to populate this tab, or paste embed code.</p>
        {% endif %}
      {% endif %}
    </div>

    <div id="pd-panel-prn-{{ sid }}" class="pd-panel" role="tabpanel" aria-labelledby="pd-tab-prn-{{ sid }}">
      <div class="pd-grid" style="gap: {{ section.settings.grid_gap }}px;">
        {% for block in section.blocks %}
          {% assign tab_select = block.settings.tab | default: '' %}
          {% assign show_this = false %}
          {% if tab_select == 'prn' %}
            {% assign show_this = true %}
          {% elsif tab_select == '' %}
            {% if block.type == 'printable' %}
              {% assign show_this = true %}
            {% endif %}
          {% endif %}
          {% if show_this %}
          <article class="pd-card" {{ block.shopify_attributes }} style="--pd-tint-color: {{ block.settings.tint_color | default: section.settings.default_tint_color }}; --pd-tint-o: {{ block.settings.tint_opacity | default: section.settings.default_tint_opacity | times: 0.01 }};">
            <a href="{{ block.settings.url }}" class="pd-card-link" aria-label="{{ block.settings.cta_text | default: 'Download' }}: {{ block.settings.title | escape }}" {% if block.settings.new_tab %}target="_blank" rel="noopener noreferrer"{% endif %}>
              <div class="pd-thumb" aria-hidden="true">
                {% if block.settings.bg_image %}
                  <img class="pd-img" src="{{ block.settings.bg_image | image_picker_url: '800x600' }}" srcset="{{ block.settings.bg_image | image_picker_url: '400x300' }} 400w, {{ block.settings.bg_image | image_picker_url: '800x600' }} 800w, {{ block.settings.bg_image | image_picker_url: '1200x900' }} 1200w" sizes="(max-width: 900px) 100vw, 50vw" alt="{{ block.settings.title | escape }}" loading="lazy" decoding="async">
                {% else %}
                  <div class="pd-thumb-placeholder" style="background: var(--pd-tint-color);"></div>
                {% endif %}
              </div>
              <div class="pd-card-body">
                {% if block.settings.badge_text != blank and block.settings.show_badge %}
                  <span class="pd-badge pd-badge--soft">{{ block.settings.badge_text }}</span>
                {% endif %}
                <h3 class="pd-card-title">{{ block.settings.title }}</h3>
                {% if block.settings.subtitle %}<p class="pd-card-sub">{{ block.settings.subtitle }}</p>{% endif %}
                {% if block.settings.meta %}
                  <div class="pd-card-meta">{% include "icon", icon: 'download', size: 16, color: 'currentColor', aria_label: '' %} {{ block.settings.meta }}</div>
                {% endif %}
                <div class="pd-card-cta">{{ block.settings.cta_text | default: section.settings.cta_default }}</div>
              </div>
            </a>
          </article>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div id="pd-panel-qa-{{ sid }}" class="pd-panel" role="tabpanel" aria-labelledby="pd-tab-qa-{{ sid }}">
      <div class="pqa-grid" style="gap: {{ section.settings.grid_gap }}px;">
        <article class="pqa-card" style="--pqa-tint-color: {{ section.settings.ask_tint_color | default: '#7E6AFF' }}; --pqa-tint-o: {{ section.settings.ask_tint_opacity | default: 72 | times: 0.01 }};">
          <div class="pqa-media" aria-hidden="true" data-bg-sm="{{ section.settings.ask_bg | image_picker_url: '800x600' }}" data-bg-lg="{{ section.settings.ask_bg | image_picker_url: '1600x900' }}" style="--placeholder-color: {{ section.settings.ask_tint_color | default: '#7E6AFF' }}"></div>
          <div class="pqa-body{% if section.settings.enable_text_contrast %} has-contrast{% endif %}" style="--text-contrast-o: {{ section.settings.text_contrast_opacity | default: 35 | times: 0.01 }}">
            <div class="pqa-row">
              <span class="pqa-icon">{% include "icon", icon: 'help-circle', size: 22, color: 'currentColor', aria_label: '' %}</span>
              <h3 class="pqa-title">{{ section.settings.ask_title }}</h3>
            </div>
            <p class="pqa-sub">{{ section.settings.ask_sub }}</p>
            <div class="pqa-ctas">
              {% if section.settings.ask_cta_text and section.settings.ask_cta_url %}
                <a href="{{ section.settings.ask_cta_url }}" class="pqa-btn pqa-btn--primary">{{ section.settings.ask_cta_text }}</a>
              {% endif %}
              {% if section.settings.ask_note %}
                <span class="pqa-chip">{% include "icon", icon: 'clock', size: 16, color: 'currentColor', aria_label: '' %} {{ section.settings.ask_note }}</span>
              {% endif %}
            </div>
          </div>
        </article>

        <article class="pqa-card" style="--pqa-tint-color: {{ section.settings.live_tint_color | default: '#18D5E4' }}; --pqa-tint-o: {{ section.settings.live_tint_opacity | default: 70 | times: 0.01 }};">
          <div class="pqa-media" aria-hidden="true" data-bg-sm="{{ section.settings.live_bg | image_picker_url: '800x600' }}" data-bg-lg="{{ section.settings.live_bg | image_picker_url: '1600x900' }}" style="--placeholder-color: {{ section.settings.live_tint_color | default: '#18D5E4' }}"></div>
          <div class="pqa-body">
            <div class="pqa-row">
              <span class="pqa-icon">{% include "icon", icon: 'calendar', size: 22, color: 'currentColor', aria_label: '' %}</span>
              <h3 class="pqa-title">{{ section.settings.live_title }}</h3>
            </div>
            <p class="pqa-sub">{{ section.settings.live_datetime }}</p>
            <div class="pqa-meta">
              {% if section.settings.live_questions %}<span class="pqa-chip">{% include "icon", icon: 'message-circle', size: 16, color: 'currentColor', aria_label: '' %} {{ section.settings.live_questions }}</span>{% endif %}
              {% if section.settings.live_duration %}<span class="pqa-chip">{% include "icon", icon: 'clock', size: 16, color: 'currentColor', aria_label: '' %} {{ section.settings.live_duration }}</span>{% endif %}
            </div>
            <div class="pqa-ctas">
              {% if section.settings.live_cta1_text and section.settings.live_cta1_url %}<a href="{{ section.settings.live_cta1_url }}" class="pqa-btn pqa-btn--secondary">{{ section.settings.live_cta1_text }}</a>{% endif %}
              {% if section.settings.live_cta2_text and section.settings.live_cta2_url %}<a href="{{ section.settings.live_cta2_url }}" class="pqa-btn pqa-btn--ghost">{{ section.settings.live_cta2_text }}</a>{% endif %}
            </div>
          </div>
        </article>
      </div>
    </div>
  </div>

  <style>
    #program-dashboard-{{ sid }} .pd-wrap{max-width:1100px; margin:0 auto; padding:32px 18px}
    #program-dashboard-{{ sid }} .pd-title{margin:0 0 6px; color:var(--c-ink-900); font-weight:700; font-size:1.8rem}
    #program-dashboard-{{ sid }} .pd-sub{color:var(--c-ink-700)}

    /* Tabs */
    #program-dashboard-{{ sid }} .pd-tabs{display:flex; gap:8px; flex-wrap:wrap; margin:14px 0}
    #program-dashboard-{{ sid }} .pd-tab{appearance:none; border:1px solid var(--c-brand-100); background:var(--c-white); color:var(--c-ink-700); padding:10px 14px; border-radius:9999px; font-weight:600; cursor:pointer}
    #program-dashboard-{{ sid }} .pd-tab:focus{outline:2px solid var(--c-brand-600); outline-offset:2px}
    #program-dashboard-{{ sid }} .pd-tab.is-active{background:var(--g-brand); color:#fff; border-color:transparent; box-shadow:0 0 12px rgba(105,78,255,.25)}

    /* Panels */
    #program-dashboard-{{ sid }} .pd-panel{display:none}
    #program-dashboard-{{ sid }} .pd-panel.is-active{display:block}
    #program-dashboard-{{ sid }} .pd-note{color:var(--c-ink-500)}

    /* Printables grid → standard cards with centered image */
    #program-dashboard-{{ sid }} .pd-grid{display:grid; grid-template-columns:repeat(2, minmax(0, 1fr))}
    #program-dashboard-{{ sid }} .pd-card{position:relative; border-radius:16px; overflow:hidden; background:#fff; border:1px solid var(--pd-tint-color, var(--c-brand-100)); box-shadow:0 6px 18px rgba(0,0,0,.06)}
    #program-dashboard-{{ sid }} .pd-card-link{display:flex; flex-direction:column; color:inherit; text-decoration:none; height:100%}
    #program-dashboard-{{ sid }} .pd-card-link:focus{outline:2px solid var(--c-brand-600); outline-offset:2px}
    #program-dashboard-{{ sid }} .pd-thumb{display:grid; place-items:center; background:var(--c-bg-light,#fafafa); aspect-ratio:16/9; border-bottom:1px solid var(--c-brand-100)}
    #program-dashboard-{{ sid }} .pd-img{width:100%; height:100%; object-fit:contain; padding:10%; filter: drop-shadow(0 8px 16px rgba(0,0,0,.12)); transition: filter var(--motion-duration-fast) var(--motion-ease-standard)}
    #program-dashboard-{{ sid }} .pd-card:hover .pd-img{filter: drop-shadow(0 12px 24px rgba(0,0,0,.18))}
    #program-dashboard-{{ sid }} .pd-thumb-placeholder{width:100%; height:100%; opacity:.08}
    #program-dashboard-{{ sid }} .pd-card-body{display:grid; gap:8px; padding:16px}
    #program-dashboard-{{ sid }} .pd-badge{position:absolute; top:12px; right:12px; font-size:.75rem; padding:4px 8px; border-radius:9999px}
    #program-dashboard-{{ sid }} .pd-badge--soft{background: color-mix(in srgb, var(--pd-tint-color, #5E3BFF) 14%, transparent); color: var(--c-ink-900); border:1px solid color-mix(in srgb, var(--pd-tint-color, #5E3BFF) 25%, transparent)}
    #program-dashboard-{{ sid }} .pd-card-title{margin:2px 0 0; color:var(--c-ink-900); font-weight:700; font-size:1.05rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    #program-dashboard-{{ sid }} .pd-card-sub{margin:0; color:var(--c-ink-700); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    #program-dashboard-{{ sid }} .pd-card-meta{margin:2px 0 0; color:var(--c-ink-500); font-size:.9rem; display:inline-flex; gap:6px; align-items:center}
    #program-dashboard-{{ sid }} .pd-card-cta{margin-top:8px; background:var(--pd-tint-color, var(--c-brand-600)); border:1px solid var(--pd-tint-color, var(--c-brand-600)); color:#fff; text-align:center; padding:10px 14px; border-radius:12px; font-weight:600}

    @media (max-width: 860px){
      #program-dashboard-{{ sid }} .pd-card-link{min-height:200px}
    }

    /* Modules static cards */
    #program-dashboard-{{ sid }} .pdm-grid{display:grid; grid-template-columns:repeat(2, minmax(0, 1fr))}
    #program-dashboard-{{ sid }} .pdm-card{position:relative; border-radius:16px; overflow:hidden; border:1px solid var(--c-brand-100); box-shadow:0 6px 18px rgba(0,0,0,.06); transition:transform var(--motion-duration-fast) var(--motion-ease-standard), box-shadow var(--motion-duration-fast) var(--motion-ease-standard)}
    #program-dashboard-{{ sid }} .pdm-card:hover{transform:translateY(-2px); box-shadow:0 16px 36px rgba(0,0,0,.12)}
    #program-dashboard-{{ sid }} .pdm-link{display:grid; min-height:260px; color:inherit; text-decoration:none; aspect-ratio: 16 / 9}
    #program-dashboard-{{ sid }} .pdm-link:focus{outline:2px solid var(--c-brand-600); outline-offset:2px}
    #program-dashboard-{{ sid }} .pdm-media{position:absolute; inset:0; background-image: var(--pdm-bg); background-size:cover; background-position:center}
    #program-dashboard-{{ sid }} .pdm-media::after{content:''; position:absolute; inset:0; background: var(--pdm-tint-color, #5E3BFF); opacity: var(--pdm-tint-o, .68)}
    #program-dashboard-{{ sid }} .pdm-body{position:relative; z-index:1; display:grid; gap:10px; align-content:end; padding:16px}
    #program-dashboard-{{ sid }} .pdm-chip{display:inline-block; color:rgba(255,255,255,.95); font-size:.9rem; font-weight:600; background:rgba(0,0,0,.28); padding:6px 10px; border-radius:9999px; margin-bottom:2px}
    #program-dashboard-{{ sid }} .pdm-body.has-contrast::before{content:''; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,var(--text-contrast-o, .35))); pointer-events:none; z-index:-1}
    /* deprecated badges for modules removed to simplify layout */
    #program-dashboard-{{ sid }} .pdm-status{position:absolute; top:12px; right:12px; background:rgba(255,255,255,.18); color:#fff; border:1px solid rgba(255,255,255,.35); font-size:.75rem; padding:4px 8px; border-radius:9999px}
    /* module top icon removed per simplification */
    /* unified chip replaces separate week/kicker styles */
    #program-dashboard-{{ sid }} .pdm-title{margin:0; color:#fff; font-weight:700; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    #program-dashboard-{{ sid }} .pdm-desc{margin:0; color:rgba(255,255,255,.95); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    #program-dashboard-{{ sid }} .pdm-meta{display:flex; gap:10px; align-items:center; color:rgba(255,255,255,.9); font-size:.9rem}
    #program-dashboard-{{ sid }} .pdm-cta{margin-top:8px; background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.35); color:#fff; text-align:center; padding:10px 14px; border-radius:12px; font-weight:600}

    /* Mobile refinements for Modules cards */
    @media (max-width: 600px){
      /* Let aspect-ratio control height on small screens */
      #program-dashboard-{{ sid }} .pdm-link{min-height:0; aspect-ratio: 16 / 10}
      /* Breathing room and readable scaling */
      #program-dashboard-{{ sid }} .pdm-body{padding:14px; gap:12px}
      #program-dashboard-{{ sid }} .pdm-title{font-size:1.05rem; line-height:1.25; margin-top:2px}
      #program-dashboard-{{ sid }} .pdm-chip{font-size:.85rem; padding:5px 9px; margin-bottom:6px}
      #program-dashboard-{{ sid }} .pdm-meta{font-size:.85rem}
      #program-dashboard-{{ sid }} .pdm-cta{padding:9px 12px}
      /* Shrink status chip slightly so it doesn't crowd */
      #program-dashboard-{{ sid }} .pdm-status{font-size:.7rem; padding:3px 7px}
    }

    /* Very small phones: increase card height slightly for legibility */
    @media (max-width: 400px){
      #program-dashboard-{{ sid }} .pdm-link{aspect-ratio: 4 / 3}
      #program-dashboard-{{ sid }} .pdm-title{font-size:1rem}
    }

    /* Q&A hero cards */
    #program-dashboard-{{ sid }} .pqa-grid{display:grid; gap:14px; grid-template-columns:repeat(2, minmax(0, 1fr))}
    @media (max-width: 900px){
      #program-dashboard-{{ sid }} .pd-grid{grid-template-columns:1fr}
      #program-dashboard-{{ sid }} .pdm-grid{grid-template-columns:1fr}
      #program-dashboard-{{ sid }} .pqa-grid{grid-template-columns:1fr}
    }
    #program-dashboard-{{ sid }} .pqa-card{position:relative; border-radius:16px; overflow:hidden; border:1px solid var(--c-brand-100); box-shadow:0 6px 18px rgba(0,0,0,.06); aspect-ratio: 16 / 9}
    #program-dashboard-{{ sid }} .pqa-media{position:absolute; inset:0; background-size:cover; background-position:center; background-color: var(--placeholder-color, #f0f0f0)}
    #program-dashboard-{{ sid }} .pqa-media::after{content:''; position:absolute; inset:0; background: var(--pqa-tint-color, #7E6AFF); opacity: var(--pqa-tint-o, .72)}
    #program-dashboard-{{ sid }} .pqa-body{position:relative; z-index:1; padding:18px; display:grid; gap:10px}
    #program-dashboard-{{ sid }} .pqa-body.has-contrast::before{content:''; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,var(--text-contrast-o, .35))); pointer-events:none; z-index:-1}
    #program-dashboard-{{ sid }} .pqa-row{display:flex; gap:10px; align-items:center}
    #program-dashboard-{{ sid }} .pqa-icon{width:34px; height:34px; border-radius:10px; display:grid; place-items:center; color:#fff; background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.25)}
    #program-dashboard-{{ sid }} .pqa-title{margin:0; color:#fff; font-weight:700; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    #program-dashboard-{{ sid }} .pqa-sub{margin:0; color:rgba(255,255,255,.95); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    #program-dashboard-{{ sid }} .pqa-meta{display:flex; gap:10px; flex-wrap:wrap}
    #program-dashboard-{{ sid }} .pqa-chip{display:inline-flex; gap:6px; align-items:center; background:rgba(255,255,255,.18); color:#fff; border:1px solid rgba(255,255,255,.35); padding:8px 10px; border-radius:9999px; font-size:.9rem}
    #program-dashboard-{{ sid }} .pqa-ctas{display:flex; gap:10px; flex-wrap:wrap}
    #program-dashboard-{{ sid }} .pqa-btn{display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:600}
    #program-dashboard-{{ sid }} .pqa-btn:focus{outline:2px solid var(--c-brand-600); outline-offset:2px}
    #program-dashboard-{{ sid }} .pqa-btn--primary{background:#fff; color:var(--c-ink-900)}
    #program-dashboard-{{ sid }} .pqa-btn--secondary{background:#fff; color:var(--c-ink-900)}
    #program-dashboard-{{ sid }} .pqa-btn--ghost{background:rgba(255,255,255,.18); color:#fff; border:1px solid rgba(255,255,255,.35)}
  </style>

  <script>
    (function(){
      var root = document.getElementById('program-dashboard-{{ sid }}');
      if(!root || root.dataset.inited==='1') return; root.dataset.inited='1';
      var tabs = [].slice.call(root.querySelectorAll('.pd-tab'));
      var panels = {
        mod: root.querySelector('#pd-panel-mod-{{ sid }}'),
        prn: root.querySelector('#pd-panel-prn-{{ sid }}'),
        qa:  root.querySelector('#pd-panel-qa-{{ sid }}')
      };
      function activate(which){
        tabs.forEach(function(t){ t.classList.remove('is-active'); t.setAttribute('aria-selected','false'); });
        Object.values(panels).forEach(function(p){ p.classList.remove('is-active'); });
        var id = 'pd-tab-'+which+'-{{ sid }}';
        var tab = root.querySelector('#'+id);
        if(!tab) return;
        tab.classList.add('is-active'); tab.setAttribute('aria-selected','true');
        root.querySelector('#pd-panel-'+which+'-{{ sid }}').classList.add('is-active');
        if(history.pushState){ history.replaceState(null,'', location.pathname + '#'+which); }
      }
      tabs.forEach(function(t){ t.addEventListener('click', function(){ var which = this.id.split('-')[2]; activate(which); }); });
      // Arrow key navigation (Left/Right/Home/End)
      root.querySelector('.pd-tabs').addEventListener('keydown', function(e){
        var keys = ['ArrowLeft','ArrowRight','Home','End']; if(keys.indexOf(e.key)===-1) return;
        e.preventDefault();
        var current = document.activeElement; var list = tabs; var idx = list.indexOf(current);
        if(e.key==='Home'){ list[0].focus(); return; }
        if(e.key==='End'){ list[list.length-1].focus(); return; }
        if(idx===-1){ list[0].focus(); return; }
        var next = e.key==='ArrowRight' ? (idx+1)%list.length : (idx-1+list.length)%list.length;
        list[next].focus();
      });
      var hash = (location.hash||'').replace('#','');
      if(['mod','prn','qa'].indexOf(hash)>-1){ activate(hash); }

      // No flip logic needed for modules anymore

      // Lazy-load background images for media elements with data-bg; add blur-in
      var lazyNodes = [].slice.call(root.querySelectorAll('[data-bg], [data-bg-sm]'));
      function setBg(el){
        if(el.dataset.bgSet==='1') return; el.dataset.bgSet='1';
        var url = el.getAttribute('data-bg');
        var urlSm = el.getAttribute('data-bg-sm');
        var urlLg = el.getAttribute('data-bg-lg');
        if(!url){ url = (window.matchMedia('(max-width: 900px)').matches ? urlSm : urlLg) || urlSm || urlLg; }
        if(!url) return;
        el.style.filter = 'blur(8px)';
        el.style.backgroundImage = 'url("'+url+'")';
        el.addEventListener('transitionend', function(){ el.style.filter=''; }, {once:true});
        setTimeout(function(){ el.style.transition='filter .6s var(--motion-ease-decelerate, ease-out)'; el.style.filter='blur(0px)'; }, 20);
      }
      if('IntersectionObserver' in window){
        var io = new IntersectionObserver(function(entries){
          entries.forEach(function(e){ if(e.isIntersecting){ setBg(e.target); io.unobserve(e.target); }});
        }, {rootMargin:'200px'});
        lazyNodes.forEach(function(n){ io.observe(n); });
      } else {
        lazyNodes.forEach(setBg);
      }

      // Prefetch destination on hover to speed navigation
      function prefetch(url){
        if(!url) return;
        try{
          var u = new URL(url, location.href);
          if(u.origin !== location.origin) return; // same-origin only
          var key = 'pref-'+u.href; if(document.getElementById(key)) return;
          var l = document.createElement('link'); l.id = key; l.rel = 'prefetch'; l.href = u.href; l.as = 'document';
          document.head.appendChild(l);
        }catch(e){ /* noop */ }
      }
      var navLinks = [].slice.call(root.querySelectorAll('.pdm-link, .pd-card-link, .pqa-btn[href]'));
      navLinks.forEach(function(a){
        var url = a.getAttribute('href');
        a.addEventListener('mouseenter', function(){ prefetch(url); }, {passive:true});
        a.addEventListener('touchstart', function(){ prefetch(url); }, {passive:true});
        a.addEventListener('focus', function(){ prefetch(url); }, {passive:true});
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Program – Dashboard Tabs",
  "elements": [
    {"type":"text","id":"heading","label":"Heading","default":"Your Secure Parenting Program"},
    {"type":"textarea","id":"subheading","label":"Subheading","default":"Jump between Modules, Printables, and Q&A."},
    {"type":"text","id":"tab_label_modules","label":"Tab label: Modules","default":"Modules"},
    {"type":"text","id":"tab_label_printables","label":"Tab label: Printables","default":"Printables"},
    {"type":"text","id":"tab_label_qa","label":"Tab label: Q&A","default":"Q&A"},
    {"type":"textarea","id":"modules_embed","label":"Modules embed (optional)","default":""},
    {"type":"textarea","id":"qa_embed","label":"Q&A embed (optional)","default":""},
    {"type":"range","id":"grid_gap","label":"Grid gap","min":8,"max":32,"step":2,"unit":"px","default":16},
    {"type":"text","id":"card_min_width","label":"Card min width","default":"280px"},
    {"type":"color","id":"default_tint_color","label":"Printables tint color","default":"#7E6AFF"},
    {"type":"range","id":"default_tint_opacity","label":"Printables tint opacity (%)","min":0,"max":100,"step":1,"default":68},
    {"type":"color","id":"modules_tint_color","label":"Modules tint color","default":"#5E3BFF"},
    {"type":"range","id":"modules_tint_opacity","label":"Modules tint opacity (%)","min":0,"max":100,"step":1,"default":68},
    {"type":"checkbox","id":"enable_text_contrast","label":"Add subtle contrast gradient behind text","default":true},
    {"type":"range","id":"text_contrast_opacity","label":"Text contrast opacity (%)","min":0,"max":80,"step":1,"default":35},
    {"type":"text","id":"cta_default","label":"Default CTA text","default":"Download PDF"},
    {"type":"image_picker","id":"ask_bg","label":"Q&A Ask card background"},
    {"type":"color","id":"ask_tint_color","label":"Q&A Ask tint color","default":"#7E6AFF"},
    {"type":"range","id":"ask_tint_opacity","label":"Q&A Ask tint opacity (%)","min":0,"max":100,"step":1,"default":72},
    {"type":"text","id":"ask_title","label":"Q&A Ask title","default":"Ask Eli Your Burning Question"},
    {"type":"textarea","id":"ask_sub","label":"Q&A Ask subtitle","default":"Get personalized guidance during our monthly live Q&A sessions."},
    {"type":"text","id":"ask_cta_text","label":"Ask CTA text","default":"Submit Your Question"},
    {"type":"action","id":"ask_cta_url","label":"Ask CTA link","default":"#"},
    {"type":"text","id":"ask_note","label":"Ask note chip","default":"Questions answered live during sessions"},
    {"type":"image_picker","id":"live_bg","label":"Live card background"},
    {"type":"color","id":"live_tint_color","label":"Live tint color","default":"#18D5E4"},
    {"type":"range","id":"live_tint_opacity","label":"Live tint opacity (%)","min":0,"max":100,"step":1,"default":70},
    {"type":"text","id":"live_title","label":"Live title","default":"Next Live Q&A Session"},
    {"type":"text","id":"live_datetime","label":"Live date/time","default":"September 25th, 2024 at 7:00 PM EST"},
    {"type":"text","id":"live_questions","label":"Live questions meta","default":"47 questions submitted"},
    {"type":"text","id":"live_duration","label":"Live duration meta","default":"~90 minutes"},
    {"type":"text","id":"live_cta1_text","label":"Live CTA 1 text","default":"Add to Calendar"},
    {"type":"action","id":"live_cta1_url","label":"Live CTA 1 link","default":"#"},
    {"type":"text","id":"live_cta2_text","label":"Live CTA 2 text","default":"Set Reminder"},
    {"type":"action","id":"live_cta2_url","label":"Live CTA 2 link","default":"#"}
  ],
  "blocks": [
    {
      "type": "printable",
      "name": "Printable card",
      "elements": [
        {"type":"select","id":"tab","label":"Show in tab","default":"prn","options":[{"label":"Modules","value":"mod"},{"label":"Printables","value":"prn"},{"label":"Q&A","value":"qa"}]},
        {"type":"image_picker","id":"bg_image","label":"Background image"},
        {"type":"color","id":"tint_color","label":"Tint color (override)","default":""},
        {"type":"range","id":"tint_opacity","label":"Tint opacity (%)","min":0,"max":100,"step":1,"default":null},
        {"type":"checkbox","id":"show_badge","label":"Show badge","default":true},
        {"type":"text","id":"badge_text","label":"Badge text","default":"PDF"},
        {"type":"text","id":"icon","label":"Icon name (shared snippet)","default":"file"},
        {"type":"text","id":"title","label":"Title","default":"Emergency Regulation Scripts"},
        {"type":"textarea","id":"subtitle","label":"Subtitle","default":"Quick reference cards for hard moments"},
        {"type":"text","id":"meta","label":"Meta (e.g., downloads)","default":"Downloaded 1,247 times"},
        {"type":"text","id":"cta_text","label":"CTA text","default":"Download PDF"},
        {"type":"action","id":"url","label":"Link","default":"#"},
        {"type":"checkbox","id":"new_tab","label":"Open in new tab","default":false}
      ]
    },
    {
      "type": "module",
      "name": "Module card",
      "elements": [
        {"type":"select","id":"tab","label":"Show in tab","default":"mod","options":[{"label":"Modules","value":"mod"},{"label":"Printables","value":"prn"},{"label":"Q&A","value":"qa"}]},
        {"type":"text","id":"week_label","label":"Week label","default":"Week 1"},
        {"type":"text","id":"emoji","label":"Emoji/Icon","default":"🔒"},
        {"type":"text","id":"kicker","label":"Kicker","default":"Understand your triggers"},
        {"type":"text","id":"title","label":"Title","default":"Cracking the Attachment Code"},
        {"type":"textarea","id":"description","label":"Description","default":"A clear 4‑step pattern map and one script to break the spiral."},
        {"type":"image_picker","id":"mod_background","label":"Background image"},
        {"type":"color","id":"mod_tint_color","label":"Tint color (override)","default":""},
        {"type":"range","id":"mod_tint_opacity","label":"Tint opacity (%)","min":0,"max":100,"step":1,"default":null},
        {"type":"text","id":"badge_text","label":"Badge text","default":"Module 1"},
        {"type":"select","id":"status","label":"Status","default":"none","options":[{"label":"None","value":"none"},{"label":"Complete","value":"complete"},{"label":"In Progress","value":"in_progress"}]},
        {"type":"checkbox","id":"show_progress","label":"Show progress bar (deprecated)","default":false},
        {"type":"text","id":"duration","label":"Duration (e.g., 52 min)","default":"52 min"},
        {"type":"action","id":"url","label":"Module link","default":"#"},
        {"type":"text","id":"cta_text","label":"CTA text","default":"Open module →"},
        {"type":"checkbox","id":"new_tab","label":"Open in new tab","default":false}
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "Program – Dashboard Tabs",
      "category": "Program",
      "blocks": [
        {"type":"module","settings":{"week_label":"Week 1","emoji":"🔒","kicker":"Understand your triggers","title":"Week 1: Cracking the Code","front_hint":"Click to flip","back_title":"Breakthrough","description":"A 4‑step pattern map when your survival brain takes over.","cta_text":"Go to module →","url":"#"}},
        {"type":"module","settings":{"week_label":"Week 2","emoji":"🤝","kicker":"Micro‑moments that matter","title":"Week 2: Building Connection","front_hint":"Click to flip","back_title":"Skill","description":"Create daily connection rituals that fit a busy life.","cta_text":"Go to module →","url":"#"}},
        {"type":"printable","settings":{"title":"Emergency Regulation Scripts","subtitle":"Quick reference cards for overwhelming moments","meta":"Downloaded 1,247 times"}},
        {"type":"printable","settings":{"title":"Age‑Specific Response Cards","subtitle":"Toddlers to teens","meta":"Downloaded 892 times"}},
        {"type":"printable","settings":{"title":"Meltdown Action Plan","subtitle":"Step‑by‑step guide","meta":"Downloaded 1,156 times"}}
      ]
    }
  ]
}
{% endschema %}
