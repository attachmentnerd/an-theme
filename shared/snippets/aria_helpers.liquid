{% comment %}
  ARIA Helpers for Improved Accessibility
  Include this snippet in interactive sections for consistent accessibility patterns
{% endcomment %}

{% comment %} Screen Reader Only Text Helper {% endcomment %}
{% capture sr_only_class %}position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0;{% endcapture %}

{% comment %} Focus Visible Styles {% endcomment %}
<style>
  /* Enhanced focus states for keyboard navigation */
  *:focus-visible {
    outline: 2px solid var(--c-brand-600, #5e3bff);
    outline-offset: 2px;
  }

  /* Skip to main content link */
  .skip-to-main {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--c-brand-600, #5e3bff);
    color: var(--c-white, #fff);
    padding: 8px;
    z-index: 100000;
    text-decoration: none;
    border-radius: 0 0 4px 0;
  }

  .skip-to-main:focus {
    top: 0;
  }

  /* Screen reader only text */
  .sr-only, .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0,0,0,0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  /* Accessible focus indicator that's not visually hidden */
  .sr-only-focusable:focus {
    position: static !important;
    width: auto !important;
    height: auto !important;
    margin: 0 !important;
    overflow: visible !important;
    clip: auto !important;
    white-space: normal !important;
  }

  /* Reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }

  /* High contrast mode adjustments */
  @media (prefers-contrast: high) {
    * {
      border-width: 0 !important;
    }

    *:focus {
      outline: 3px solid currentColor !important;
      outline-offset: 0 !important;
    }

    button,
    a,
    input,
    select,
    textarea {
      border: 1px solid currentColor !important;
    }
  }

  /* Minimum touch target size for mobile */
  @media (pointer: coarse) {
    button,
    a,
    input[type="checkbox"],
    input[type="radio"],
    select {
      min-height: 44px;
      min-width: 44px;
    }
  }

  /* Form validation states with ARIA */
  [aria-invalid="true"] {
    border-color: #dc2626 !important;
  }

  [aria-invalid="false"] {
    border-color: #10b981 !important;
  }

  /* Loading states */
  [aria-busy="true"] {
    cursor: wait;
    opacity: 0.7;
  }

  /* Disabled states */
  [aria-disabled="true"],
  [disabled] {
    cursor: not-allowed;
    opacity: 0.5;
    pointer-events: none;
  }
</style>

{% comment %} Common ARIA Live Region for Announcements {% endcomment %}
<div class="sr-only" aria-live="polite" aria-atomic="true" id="aria-live-region"></div>

{% comment %} Skip to main content link {% endcomment %}
<a href="#main-content" class="skip-to-main">Skip to main content</a>

<script>
  // Enhanced keyboard navigation support
  document.addEventListener('DOMContentLoaded', function() {
    // Add role="button" keyboard support
    document.querySelectorAll('[role="button"]').forEach(function(element) {
      if (!element.hasAttribute('tabindex')) {
        element.setAttribute('tabindex', '0');
      }

      element.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          element.click();
        }
      });
    });

    // Trap focus in modals
    document.querySelectorAll('[role="dialog"]').forEach(function(modal) {
      const focusableElements = modal.querySelectorAll(
        'a[href], button, textarea, input[type="text"], input[type="radio"], input[type="checkbox"], select'
      );
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];

      modal.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
          if (e.shiftKey) { // Shift + Tab
            if (document.activeElement === firstFocusable) {
              lastFocusable.focus();
              e.preventDefault();
            }
          } else { // Tab
            if (document.activeElement === lastFocusable) {
              firstFocusable.focus();
              e.preventDefault();
            }
          }
        }

        if (e.key === 'Escape') {
          // Close modal
          const closeButton = modal.querySelector('[aria-label*="Close"], .close');
          if (closeButton) closeButton.click();
        }
      });
    });

    // Announce form errors to screen readers
    document.querySelectorAll('form').forEach(function(form) {
      form.addEventListener('submit', function(e) {
        const errors = form.querySelectorAll('[aria-invalid="true"]');
        if (errors.length > 0) {
          const liveRegion = document.getElementById('aria-live-region');
          if (liveRegion) {
            liveRegion.textContent = `Form has ${errors.length} error${errors.length > 1 ? 's' : ''}. Please review and correct.`;
          }
        }
      });
    });

    // Add aria-current to active navigation
    const currentPath = window.location.pathname;
    document.querySelectorAll('nav a[href]').forEach(function(link) {
      if (link.pathname === currentPath) {
        link.setAttribute('aria-current', 'page');
      }
    });
  });
</script>