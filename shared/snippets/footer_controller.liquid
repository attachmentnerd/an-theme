{% comment %}
Footer Controller Snippet
Provides centralized footer rendering with global theme controls plus
optional overrides for specific layouts or templates.

Priority order:
1. `force_hide` parameter (always hides)
2. `force_show` parameter (always shows)
3. Global theme toggle (`settings.show_footer`)
4. Path-based suppression via `settings.footer_hide_paths`

Usage Examples:
{% include 'footer_controller' %}
{% include 'footer_controller', force_hide: true %}
{% include 'footer_controller', footer_section: 'nav_footer_bio' %}
{% endcomment %}

{% assign should_show_footer = false %}

{% comment %} Determine which footer section to render {% endcomment %}
{% assign resolved_footer_section = footer_section %}
{% if resolved_footer_section == blank %}
  {% assign resolved_footer_section = settings.global_footer_section %}
{% endif %}
{% if resolved_footer_section == blank %}
  {% assign resolved_footer_section = 'nav_footer_modern' %}
{% endif %}

{% comment %} Normalize global toggle so legacy installs default to true {% endcomment %}
{% assign global_footer_enabled = settings.show_footer %}
{% if global_footer_enabled == blank %}
  {% assign global_footer_enabled = true %}
{% elsif global_footer_enabled == true or global_footer_enabled == 'true' %}
  {% assign global_footer_enabled = true %}
{% elsif global_footer_enabled == false or global_footer_enabled == 'false' %}
  {% assign global_footer_enabled = false %}
{% endif %}

{% comment %} Visibility precedence {% endcomment %}
{% if force_hide %}
  {% assign should_show_footer = false %}
{% elsif force_show %}
  {% assign should_show_footer = true %}
{% elsif global_footer_enabled %}
  {% assign should_show_footer = true %}
{% endif %}

{% comment %}
  Apply path-based suppression unless force_show is active.
  Supports newline-delimited entries with optional wildcard * suffix.
{% endcomment %}
{% assign hide_footer_for_path = false %}
{% if force_show != true and should_show_footer %}
  {% assign current_path = request.path | default: '/' %}
  {% assign current_path = current_path | downcase | strip %}
  {% assign current_path = current_path | replace: '//', '/' %}
  {% assign current_length = current_path | size %}
  {% if current_length == 0 %}
    {% assign current_path = '/' %}
    {% assign current_length = 1 %}
  {% endif %}
  {% if current_path != '/' %}
    {% assign current_last_index = current_length | minus: 1 %}
    {% assign current_last_char = current_path | slice: current_last_index, 1 %}
    {% if current_last_char == '/' %}
      {% assign trimmed_length = current_length | minus: 1 %}
      {% assign current_path = current_path | slice: 0, trimmed_length %}
      {% assign current_length = current_path | size %}
      {% if current_length == 0 %}
        {% assign current_path = '/' %}
        {% assign current_length = 1 %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% assign raw_hide_paths = settings.footer_hide_paths | default: '' %}
  {% if raw_hide_paths != '' %}
    {% assign normalized_hide_paths = raw_hide_paths | replace: '\r\n', '\n' | replace: '\r', '\n' %}
    {% assign hide_path_entries = normalized_hide_paths | split: '\n' %}
    {% for raw_entry in hide_path_entries %}
      {% assign entry = raw_entry | strip %}
      {% if entry != '' %}
        {% assign entry = entry | downcase | replace: '//', '/' %}
        {% assign is_wildcard = false %}
        {% assign entry_length = entry | size %}
        {% if entry_length > 0 %}
          {% assign entry_last_index = entry_length | minus: 1 %}
          {% assign entry_last_char = entry | slice: entry_last_index, 1 %}
          {% if entry_last_char == '*' %}
            {% assign is_wildcard = true %}
            {% assign trimmed_length = entry_length | minus: 1 %}
            {% assign entry = entry | slice: 0, trimmed_length %}
          {% endif %}
        {% endif %}
        {% assign entry_length = entry | size %}
        {% if entry_length > 0 %}
          {% assign entry_first_char = entry | slice: 0, 1 %}
          {% if entry_first_char != '/' %}
            {% assign entry = '/' | append: entry %}
          {% endif %}
        {% endif %}
        {% assign entry_length = entry | size %}
        {% if entry != '/' and entry_length > 1 %}
          {% assign entry_last_index = entry_length | minus: 1 %}
          {% assign entry_last_char = entry | slice: entry_last_index, 1 %}
          {% if entry_last_char == '/' %}
            {% assign trimmed_length = entry_length | minus: 1 %}
            {% assign entry = entry | slice: 0, trimmed_length %}
            {% assign entry_length = entry | size %}
          {% endif %}
        {% endif %}

        {% if entry_length == 0 %}
          {% assign hide_footer_for_path = true %}
        {% elsif is_wildcard %}
          {% if current_path == entry %}
            {% assign hide_footer_for_path = true %}
          {% elsif entry_length > 0 %}
            {% assign candidate = current_path | slice: 0, entry_length %}
            {% if candidate == entry %}
              {% assign hide_footer_for_path = true %}
            {% endif %}
          {% endif %}
        {% elsif current_path == entry %}
          {% assign hide_footer_for_path = true %}
        {% endif %}
      {% endif %}
      {% if hide_footer_for_path %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% if hide_footer_for_path %}
  {% assign should_show_footer = false %}
{% endif %}

{% comment %} Render footer if visible {% endcomment %}
{% if should_show_footer %}
  {% case resolved_footer_section %}
    {% when 'nav_footer_bio' %}
      {% section 'nav_footer_bio' %}
    {% when 'nav_footer_modern' %}
      {% section 'nav_footer_modern' %}
    {% else %}
      {% section 'nav_footer_modern' %}
  {% endcase %}
{% endif %}
